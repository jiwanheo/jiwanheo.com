
<!DOCTYPE html>
<html lang="en">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta http-equiv="X-UA-Compatible" content="ie=edge"/>
<meta name="theme-color" content="#478079" >



<title>Jiwan Heo | Cloud Solutions Architect | Full-stack web app developer</title>
<meta name="description" content='Freelance AWS cloud solutions architect &amp; full-stack web app developer: I work with businesses to design, develop, and deploy applications that scale. Let&#39;s collaborate to transform your idea into a functional, cloud-ready product.'>


<style data-generator="critical-css">

</style>



    
        
        
    

    
        
        
    

    
        
        
    

  
  
  
  
  <link rel="stylesheet" href="http://localhost:1313/css/menu.6e233ea8020133c8fdf840fc9876a529cacbe674c7d8193cc12963d7eb29f253.css" integrity="sha256-biM&#43;qAIBM8j9&#43;ED8mHalKcrL5nTH2Bk8wSlj1&#43;sp8lM=">







 


<link
  rel="preload"
  href="/css/bundle.css"
  as="style"
  data-generator="purgeCSS"
  onload="this.onload=null;this.rel='stylesheet'"
  
/>
<noscript>
  <link 
    rel="stylesheet" 
    href="/css/bundle.css"
    
  />
</noscript>



<script src='http://localhost:1313/js/library/lozad.min.js'></script>

 

  </head>

  <body>
    

<header class="header fixed-top rad-animation-group" id="header">
  <div class="container rad-fade-in">
    <nav class="navbar navbar-expand-lg navbar-light p-0">
      <div class="container-fluid">
        <a class="navbar-brand mx-auto" href="http://localhost:1313/">
          <span></span>
          <span></span>
        </a>
        <button
          class="navbar-toggler collapsed"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent, #header"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav ml-lg-auto">
            <li class="nav-item">
              <a class="nav-link active" href="http://localhost:1313/">HOME</a>
            </li>
            
            <li class="nav-item">
              <a data-scroll class="nav-link" href="/#about"
                >ABOUT</a
              >
            </li>
            
            <li class="nav-item">
              <a data-scroll class="nav-link" href="/#experience"
                >EXPERIENCE</a
              >
            </li>
            
            <li class="nav-item">
              <a data-scroll class="nav-link" href="/blog"
                >BLOG</a
              >
            </li>
            
            <li class="nav-item">
              <a data-scroll class="nav-link" href="/#contact"
                >CONTACT</a
              >
            </li>
            
          </ul>
        </div>
      </div>
    </nav>
  </div>
</header>

    <section
      id="blog-single"
      class="section section--border-bottom rad-animation-group"
    >
      <div class="container">
        <div class="col-12">
          <div class="blog-post-title">
            <h1>Hosting Static Websites on AWS: A Step-by-Step Guide</h1>
            <span class="date">2024-12-09</span>  
          </div>

          
          

          <div class="row flex-column-reverse flex-md-row rad-fade-down">
            <div class="col-12"><p>Static websites are a simple and effective way to share content online, and AWS provides powerful tools to host and scale them efficiently. This blog post walks you through a hands-on project to create and deploy a static website on AWS, leveraging S3, Route 53, and a range of other AWS services. The project is broken into four distinct phases, each building upon the last, to guide you from setting up basic hosting to implementing advanced features like CI/CD, monitoring, and infrastructure as code (IaC).</p>
<p>Whether you&rsquo;re brushing up on AWS skills from recent certifications or exploring new ways to optimize your workflows, this guide offers a clear, structured approach to mastering static website hosting on AWS. From configuring S3 buckets and custom domains to automating deployments with GitHub and enhancing performance with CloudFront, we&rsquo;ll cover it all.</p>
<p>Let’s get started!</p>
<h2 id="overview-of-the-project">Overview of the Project</h2>
<p>We&rsquo;ll host a simple static website on S3 with a custom domain name, applying tools and techniques to automate and enhance the process. Here&rsquo;s the plan:</p>
<h3 id="tech-stack">Tech Stack</h3>
<p><strong>AWS Services</strong>: S3, Route 53, ACM, CloudFront, CloudWatch, SNS, CloudFormation</p>
<p><strong>CI/CD Tools</strong>: GitHub Actions</p>
<p><strong>Development Framework</strong>: Next.js</p>
<h3 id="project-phases">Project Phases</h3>
<p><strong>1. Setup Static Hosting</strong>: Host a basic static website on S3 and configure DNS with Route 53.</p>
<p><strong>2. Implement CI/CD</strong>: Use GitHub to automate deployment of website updates to S3.</p>
<p><strong>3. Add Enhancements</strong>: Integrate SSL/TLS, CDN, monitoring, and alerting for traffic management.</p>
<p><strong>4. Infrastructure as Code (IaC)</strong>: Migrate all configurations to CloudFormation templates for reproducibility.</p>
<h2 id="phase-1-static-website-hosting">Phase 1: Static Website Hosting</h2>
<h3 id="step-1-create-a-nextjs-application">Step 1: Create a Next.js Application</h3>
<p>Start a new project with <code>npm create-next-app@latest site</code>. Use default configurations. Your repo should look like this:</p>
<pre tabindex="0"><code>repo-root/
├── site/ 
│ ├── app
│ ├── node_modules
│ ├── next.config.ts
│ └── ...
│
├── README.md 
└── .gitignore 
</code></pre><p>Test the development environment by running <code>npm run dev</code>.</p>
<p><img src="screenshots/static-1.png" alt=""></p>
<p>Update the next.config.js file to enable static export at line 5.</p>
<p><img src="screenshots/static-2.png" alt=""></p>
<p>Then build the project using <code>npm run build</code>. This generates an <code>out</code> folder containing the website&rsquo;s static files.</p>
<p><img src="screenshots/static-3.png" alt=""></p>
<h3 id="step-2-set-up-s3-bucket">Step 2: Set Up S3 Bucket</h3>
<p>Create an S3 bucket in the AWS console. The bucket name must match your intended domain (e.g., static-site.example.com).</p>
<p><img src="screenshots/s3-1.png" alt=""></p>
<p><img src="screenshots/s3-2.png" alt=""></p>
<p>Enable versioning and disable “Block all public access.”</p>
<p><img src="screenshots/s3-3.png" alt=""></p>
<p><img src="screenshots/s3-4.png" alt=""></p>
<p>Then, create the bucket, and upload the contents of the out folder to the bucket (just the contents, so that the &ldquo;index.html&rdquo; file is at the root level).</p>
<p><img src="screenshots/s3-5.png" alt=""></p>
<p><img src="screenshots/s3-6.png" alt=""></p>
<p>In the &ldquo;Properties&rdquo; tab, enable static website hosting and set index.html as the index document.</p>
<p><img src="screenshots/s3-7.png" alt=""></p>
<p>Go to the &ldquo;Permissions&rdquo; tab to edit bucket policy, in order to allow GET access to the public. Click on &ldquo;Edit&rdquo;.</p>
<p><img src="screenshots/s3-8.png" alt=""></p>
<p>Then, paste the following policy, to allow <code>getObject</code> on all items under our s3 bucket to anybody.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JSON" data-lang="JSON"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#8839ef">&#34;Version&#34;</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#8839ef">&#34;Statement&#34;</span>: [
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#8839ef">&#34;Sid&#34;</span>: <span style="color:#40a02b">&#34;Statement1&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#8839ef">&#34;Principal&#34;</span>: <span style="color:#40a02b">&#34;*&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#8839ef">&#34;Effect&#34;</span>: <span style="color:#40a02b">&#34;Allow&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#8839ef">&#34;Action&#34;</span>: <span style="color:#40a02b">&#34;s3:GetObject&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#8839ef">&#34;Resource&#34;</span>: <span style="color:#40a02b">&#34;arn:aws:s3:::static-site.jiwanheo.xyz/*&#34;</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Once you hit save, and come back to the &ldquo;Static website hosting&rdquo; in the Properties tab, you should see a Bucket website endpoint.</p>
<p><img src="screenshots/s3-9.png" alt=""></p>
<h3 id="step-3-configure-public-route53-access">Step 3: Configure Public Route53 Access</h3>
<p>I happen to already have a hosted zone in AWS, so I&rsquo;ll be using that domain.</p>
<p>In your hosted zone, hit &ldquo;Create record&rdquo;</p>
<p><img src="screenshots/route53-1.png" alt=""></p>
<p>Create an &ldquo;A&rdquo; record that points to the website endpoint of our s3 bucket.</p>
<p><img src="screenshots/route53-2.png" alt=""></p>
<p>After this, the <code>static-site.jiwanheo.xyz</code> domain will point to our static website. It might take a few minutes for the DNS to propagate.</p>
<p><img src="screenshots/route53-3.png" alt=""></p>
<h3 id="section-wrap-up">Section wrap-up</h3>
<p>We have the basic functionality working for our static website. We&rsquo;ve explored two options to making a static website publicly accessible: using static site hosting in S3, and using an A record to point to the bucket.</p>
<p>With that, push your code upto Github, and let&rsquo;s move on to the next phase.</p>
<h2 id="phase-2-implement-cicd">Phase 2: Implement CI/CD</h2>
<h3 id="step-1-set-up-aws-credentials-in-github">Step 1: Set Up AWS Credentials in Github</h3>
<p>Set up your AWS credentials (access key &amp; secret access key) with Github. Within your repo, go to Settings -&gt; Secrets and variables -&gt; Actions.</p>
<p><img src="screenshots/gh-1.png" alt=""></p>
<p>Hit &ldquo;New repository secret&rdquo;, and set up <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code> with your creds. If you don&rsquo;t already have them, you can generate them from the IAM console.</p>
<h3 id="step-2-create-github-actions-workflow">Step 2: Create GitHub Actions Workflow</h3>
<p>Add a .github/workflows/deploy.yml file to automate builds and uploads to S3. Your directory should look like this:</p>
<pre tabindex="0"><code>repo-root/
├── .github/ 
│ ├── workflows
│ │ ├── deploy.yml
|
├── site/
│ ├── index.html
| ├── ...
│
└── README.md
</code></pre><p>In the deploy.yml, paste the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">name</span>: Deploy Next.js to S3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">on</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">push</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">branches</span>:
</span></span><span style="display:flex;"><span>      - phase2 <span style="color:#9ca0b0;font-style:italic"># This will trigger the workflow when you push to the &#39;phase2&#39; branch</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">jobs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">build_and_deploy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">runs-on</span>: ubuntu-latest <span style="color:#9ca0b0;font-style:italic"># This specifies the environment the job will run in</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">steps</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#8839ef">name</span>: Checkout code
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">uses</span>: actions/checkout@v2 <span style="color:#9ca0b0;font-style:italic"># Checkout the code from your repository</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      - <span style="color:#8839ef">name</span>: Set up Node.js
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">uses</span>: actions/setup-node@v2
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">with</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">node-version</span>: <span style="color:#40a02b">&#34;v21.7.1&#34;</span> <span style="color:#9ca0b0;font-style:italic"># Specify the Node.js version you want to use</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      - <span style="color:#8839ef">name</span>: Install dependencies
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">run</span>: |<span style="color:#9ca0b0">
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">          cd site  # Navigate to the &#39;site&#39; directory
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">          npm install  # Now &#39;npm install&#39; will work in the correct directory</span>          
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      - <span style="color:#8839ef">name</span>: Build the app
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">run</span>: |<span style="color:#9ca0b0">
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">          cd site  # Make sure we are in the &#39;site&#39; directory
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">          npm run build  # Run the build process</span>          
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#9ca0b0;font-style:italic"># Install and start a local server to preview the build</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#8839ef">name</span>: Install http-server
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">run</span>: |<span style="color:#9ca0b0">
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">          cd site
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">          npm install -g http-server</span>          
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      - <span style="color:#8839ef">name</span>: Preview the site (Local Server)
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">run</span>: |<span style="color:#9ca0b0">
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">          cd site/out
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">          http-server -p 8080 &amp;  # Run in background on port 8080
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">          sleep 10  # Allow some time for the server to start
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">          curl http://localhost:8080  # Test the server</span>          
</span></span></code></pre></div><p>Nothing very special about this yml file. The first few steps are very standard for checking out code, setting up node, installing dependencies, then building the app. Then after, I&rsquo;m previewing the built site, then curl&rsquo;ing the server, to see if it built correctly. If all goes well, we can replace this step with a new step that copies over files to S3 bucket.</p>
<p>I&rsquo;ll push this up, and github should automatically detect and run the workflow file.</p>
<p><img src="screenshots/gh-2.png" alt=""></p>
<h3 id="step-3-adjust-iam-permissions">Step 3: Adjust IAM Permissions</h3>
<p>The next step, is to ensure proper IAM permissions are set, that&rsquo;ll let us interact with S3.</p>
<p>To do this, go to the IAM console. My user already is an admin, so I don&rsquo;t have to do anything, but if not, you&rsquo;d want to make sure to create a policy that covers actions like &ldquo;s3:ListBucket&rdquo;, &ldquo;s3:GetObject&rdquo;, &ldquo;s3:PutObject&rdquo;, &ldquo;s3:DeleteObject&rdquo;.</p>
<p><img src="screenshots/iam-1.png" alt=""></p>
<h3 id="step-4-complete-github-actions-workflow">Step 4: Complete GitHub Actions Workflow</h3>
<p>Now that we have proper permissions, we&rsquo;re going to replace the &ldquo;Install http-server&rdquo; and &ldquo;Preview the site (Local Server)&rdquo; steps with actually deploying to S3.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span>- <span style="color:#8839ef">name</span>: Deploy to S3
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">run</span>: |<span style="color:#9ca0b0">
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">    cd site  # Ensure we are in the &#39;site&#39; directory
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">    aws s3 sync out/ s3://static-site.jiwanheo.xyz --delete  # Deploy the &#39;out&#39; folder to S3</span>    
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">env</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">AWS_ACCESS_KEY_ID</span>: ${{ secrets.AWS_ACCESS_KEY_ID }}
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">AWS_SECRET_ACCESS_KEY</span>: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">AWS_DEFAULT_REGION</span>: <span style="color:#40a02b">&#39;us-east-2&#39;</span>
</span></span></code></pre></div><p>Push this up, and we should see that the S3 bucket is updated. We can see this in both the S3 static website link, and the Route 53 A record we set up.</p>
<p><img src="screenshots/iam-2.png" alt=""></p>
<p><img src="screenshots/iam-3.png" alt=""></p>
<h3 id="section-wrap-up-1">Section wrap-up</h3>
<p>Great! To close this section, I&rsquo;m going to change the YAML&rsquo;s target branch to main, as well as triggering it on PRs.</p>
<h2 id="phase-3-add-enhancements">Phase 3: Add Enhancements</h2>
<h3 id="step-1-enable-ssltls-with-acm">Step 1: Enable SSL/TLS with ACM</h3>
<p>Request an SSL/TLS certificate for your domain in the ACM console. (Make sure you&rsquo;re in us-east-1 region)</p>
<p><img src="screenshots/acm-1.png" alt=""></p>
<p>If you click on the certificate that we just created, there should be a &ldquo;Create records in Route 53&rdquo; button. Click it, then create record. Validate the certificate by creating CNAME records in Route 53. Give it some time, and it should say &ldquo;Issued&rdquo;.</p>
<p><img src="screenshots/acm-2.png" alt=""></p>
<h3 id="step-2-set-up-cloudfront">Step 2: Set Up CloudFront</h3>
<p>Create a CloudFront distribution pointing to your S3 bucket.</p>
<p><img src="screenshots/cloudfront-1.png" alt=""></p>
<p>Scroll down and set Viewer Protocol Policy to Redirect HTTP to HTTPS (for security).</p>
<p><img src="screenshots/cloudfront-2.png" alt=""></p>
<p>I&rsquo;m going to pass on WAF for now.</p>
<p><img src="screenshots/cloudfront-3.png" alt=""></p>
<p>Fill in our domain &ldquo;static-site.jiwanheo.xyz&rdquo; in the Alternate domain name, and link it with the SSL cert we created.</p>
<p><img src="screenshots/cloudfront-4.png" alt=""></p>
<p>Finally, have &ldquo;index.html&rdquo; as default root object.</p>
<p><img src="screenshots/cloudfront-5.png" alt=""></p>
<p>Hit &ldquo;Create distribution&rdquo;, and wait a few minutes for it to be enabled.</p>
<h3 id="step-3-update-route-53">Step 3: Update Route 53</h3>
<p>We&rsquo;re going to remove the previously defined <code>static-site.jiwanheo.xyz</code> that links to the S3 bucket, and point it to the cloudfront distribution.</p>
<p>Delete the A record.</p>
<p><img src="screenshots/update-route53-1.png" alt=""></p>
<p>Fill it with the Cloudfront distribution.</p>
<p><img src="screenshots/update-route53-2.png" alt=""></p>
<p>Then we can visit &ldquo;static-site.jiwanheo.xyz&rdquo;, to see it&rsquo;s redirected to https.</p>
<p><img src="screenshots/update-route53-3.png" alt=""></p>
<h3 id="step-4-enhance-s3-security">Step 4: Enhance S3 Security</h3>
<p>Let&rsquo;s make S3 bucket a little more secure, by making it private, and using OAC to grant CloudFront access.</p>
<p>From my CloudFront distribution, go to Origins section, and select the S3 origin, and edit.</p>
<p><img src="screenshots/s3-security-1.png" alt=""></p>
<p>And we&rsquo;ll create an OAC. Copy the policy.</p>
<p><img src="screenshots/s3-security-2.png" alt=""></p>
<p>Go to S3 bucket, and replace the existing policy with the new one. Then, block all public access.</p>
<p>After the Cloudfront distribution propagates, we can check that accessing the S3 bucket directly, gives 403 error.</p>
<p><img src="screenshots/s3-security-3.png" alt=""></p>
<p>However, accessing the cloudfront distribution through <code>static-site.jiwanheo.xyz</code> works.</p>
<p><img src="screenshots/s3-security-4.png" alt=""></p>
<h3 id="step-5-monitor-and-manage-traffic">Step 5: Monitor and Manage Traffic</h3>
<p>To optimize resource usage and manage AWS costs effectively, we will implement a monitoring and response system using AWS CloudWatch, SNS, and Lambda. The goal is to monitor traffic patterns and automatically handle traffic spikes by temporarily disabling the CloudFront distribution when necessary. Here&rsquo;s the overview of what we&rsquo;ll implement.</p>
<p><strong>Monitoring Traffic with CloudWatch</strong>: CloudWatch will track the number of requests to the CloudFront distribution. If the traffic exceeds a predefined threshold, it will trigger an alarm. Similarly, a separate alarm will detect when traffic returns to normal levels.</p>
<p><strong>Notifying via SNS</strong>: When the CloudWatch alarm is triggered, it will send a notification to Amazon Simple Notification Service (SNS). This allows for seamless integration and communication with other AWS services.</p>
<p><strong>Automated Response with Lambda</strong>: A Lambda function subscribed to the SNS topic will automatically take action based on the alarm&rsquo;s state:</p>
<ul>
<li>
<p>High Traffic: The Lambda function will disable the CloudFront distribution to prevent excessive costs.</p>
</li>
<li>
<p>Normal Traffic: When traffic levels normalize, the Lambda function will re-enable the CloudFront distribution.
This setup ensures an automated, cost-effective, and scalable solution to handle traffic fluctuations without manual intervention.</p>
</li>
</ul>
<p>Go to the SNS console, and create a standard topic.</p>
<p><img src="screenshots/sns-1.png" alt=""></p>
<p>After you&rsquo;ve created it, go into it, and create a subscription for our email. Click &ldquo;Create subscription&rdquo;. This will send us an email anytime SNS receives a message from CloudWatch.</p>
<p><img src="screenshots/sns-2.png" alt=""></p>
<p>Go to Lambda console, and create a function from scratch. Give it a name, and select Python as runtime.</p>
<p><img src="screenshots/lambda-1.png" alt=""></p>
<p>And paste the following into the editor, and deploy the function. This code reads the message from SNS, and determine which state the alarm is (in alarm/OK), as well as CloudFront distribution ID. Then, depending on the state, we disable/enable the distribution.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#179299">import</span> <span style="color:#fe640b">boto3</span>
</span></span><span style="display:flex;"><span><span style="color:#179299">import</span> <span style="color:#fe640b">json</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"># Create CloudFront client</span>
</span></span><span style="display:flex;"><span>cloudfront <span style="color:#04a5e5;font-weight:bold">=</span> boto3<span style="color:#04a5e5;font-weight:bold">.</span>client(<span style="color:#40a02b">&#39;cloudfront&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">def</span> <span style="color:#1e66f5">lambda_handler</span>(event, context):
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic"># Extract the SNS message</span>
</span></span><span style="display:flex;"><span>    sns_message <span style="color:#04a5e5;font-weight:bold">=</span> event[<span style="color:#40a02b">&#39;Records&#39;</span>][<span style="color:#fe640b">0</span>][<span style="color:#40a02b">&#39;Sns&#39;</span>][<span style="color:#40a02b">&#39;Message&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic"># Parse the SNS message (which is JSON inside a string)</span>
</span></span><span style="display:flex;"><span>    alarm_details <span style="color:#04a5e5;font-weight:bold">=</span> json<span style="color:#04a5e5;font-weight:bold">.</span>loads(sns_message)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic"># Extract details</span>
</span></span><span style="display:flex;"><span>    alarm_state <span style="color:#04a5e5;font-weight:bold">=</span> alarm_details[<span style="color:#40a02b">&#39;NewStateValue&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic"># Extract CloudFront DistributionId from Dimensions</span>
</span></span><span style="display:flex;"><span>    trigger_details <span style="color:#04a5e5;font-weight:bold">=</span> alarm_details<span style="color:#04a5e5;font-weight:bold">.</span>get(<span style="color:#40a02b">&#39;Trigger&#39;</span>, {})
</span></span><span style="display:flex;"><span>    dimensions <span style="color:#04a5e5;font-weight:bold">=</span> trigger_details<span style="color:#04a5e5;font-weight:bold">.</span>get(<span style="color:#40a02b">&#39;Dimensions&#39;</span>, [])
</span></span><span style="display:flex;"><span>    distribution_id <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#fe640b">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">for</span> dimension <span style="color:#04a5e5;font-weight:bold">in</span> dimensions:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">if</span> dimension[<span style="color:#40a02b">&#39;name&#39;</span>] <span style="color:#04a5e5;font-weight:bold">==</span> <span style="color:#40a02b">&#39;DistributionId&#39;</span>:
</span></span><span style="display:flex;"><span>            distribution_id <span style="color:#04a5e5;font-weight:bold">=</span> dimension[<span style="color:#40a02b">&#39;value&#39;</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic"># Initialize CloudFront client</span>
</span></span><span style="display:flex;"><span>    client <span style="color:#04a5e5;font-weight:bold">=</span> boto3<span style="color:#04a5e5;font-weight:bold">.</span>client(<span style="color:#40a02b">&#39;cloudfront&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#9ca0b0;font-style:italic"># Get the current distribution configuration</span>
</span></span><span style="display:flex;"><span>        response <span style="color:#04a5e5;font-weight:bold">=</span> client<span style="color:#04a5e5;font-weight:bold">.</span>get_distribution_config(Id<span style="color:#04a5e5;font-weight:bold">=</span>distribution_id)
</span></span><span style="display:flex;"><span>        config <span style="color:#04a5e5;font-weight:bold">=</span> response[<span style="color:#40a02b">&#39;DistributionConfig&#39;</span>]
</span></span><span style="display:flex;"><span>        etag <span style="color:#04a5e5;font-weight:bold">=</span> response[<span style="color:#40a02b">&#39;ETag&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#9ca0b0;font-style:italic"># Check current state and update &#39;Enabled&#39; field based on alarm state</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">if</span> alarm_state <span style="color:#04a5e5;font-weight:bold">==</span> <span style="color:#40a02b">&#34;ALARM&#34;</span>:
</span></span><span style="display:flex;"><span>            config[<span style="color:#40a02b">&#39;Enabled&#39;</span>] <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#fe640b">False</span>  <span style="color:#9ca0b0;font-style:italic"># Disable the distribution</span>
</span></span><span style="display:flex;"><span>            action <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#40a02b">&#34;disable&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">elif</span> alarm_state <span style="color:#04a5e5;font-weight:bold">==</span> <span style="color:#40a02b">&#34;OK&#34;</span>:
</span></span><span style="display:flex;"><span>            config[<span style="color:#40a02b">&#39;Enabled&#39;</span>] <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#fe640b">True</span>   <span style="color:#9ca0b0;font-style:italic"># Enable the distribution</span>
</span></span><span style="display:flex;"><span>            action <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#40a02b">&#34;enable&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">return</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#40a02b">&#34;statusCode&#34;</span>: <span style="color:#fe640b">200</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#40a02b">&#34;body&#34;</span>: <span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;No action needed for state: </span><span style="color:#40a02b">{</span>alarm_state<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#9ca0b0;font-style:italic"># Update the distribution configuration</span>
</span></span><span style="display:flex;"><span>        update_response <span style="color:#04a5e5;font-weight:bold">=</span> client<span style="color:#04a5e5;font-weight:bold">.</span>update_distribution(
</span></span><span style="display:flex;"><span>            Id<span style="color:#04a5e5;font-weight:bold">=</span>distribution_id,
</span></span><span style="display:flex;"><span>            IfMatch<span style="color:#04a5e5;font-weight:bold">=</span>etag,
</span></span><span style="display:flex;"><span>            DistributionConfig<span style="color:#04a5e5;font-weight:bold">=</span>config
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#40a02b">&#34;statusCode&#34;</span>: <span style="color:#fe640b">200</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#40a02b">&#34;body&#34;</span>: <span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;CloudFront distribution </span><span style="color:#40a02b">{</span>distribution_id<span style="color:#40a02b">}</span><span style="color:#40a02b"> successfully </span><span style="color:#40a02b">{</span>action<span style="color:#40a02b">}</span><span style="color:#40a02b">d.&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">except</span> <span style="color:#fe640b">Exception</span> <span style="color:#8839ef">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#40a02b">&#34;statusCode&#34;</span>: <span style="color:#fe640b">500</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#40a02b">&#34;body&#34;</span>: <span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Error updating CloudFront distribution: </span><span style="color:#40a02b">{</span><span style="color:#04a5e5">str</span>(e)<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><p>Now, we&rsquo;ll give lambda an IAM role to be able to interact with CloudFront and CloudWatch Logs. Go to IAM console, and go to the &ldquo;role&rdquo; section to create a new role.</p>
<p><img src="screenshots/lambda-2.png" alt=""></p>
<p>I created an empty role, then went into the permissions policies section to add an inline policy. Make sure to change the arn&rsquo;s in &ldquo;Resource&rdquo; part.</p>
<p><img src="screenshots/lambda-3.png" alt=""></p>
<p>I used the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JSON" data-lang="JSON"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#8839ef">&#34;Version&#34;</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#8839ef">&#34;Statement&#34;</span>: [
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#8839ef">&#34;Effect&#34;</span>: <span style="color:#40a02b">&#34;Allow&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#8839ef">&#34;Action&#34;</span>: [
</span></span><span style="display:flex;"><span>				<span style="color:#40a02b">&#34;cloudfront:GetDistributionConfig&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#40a02b">&#34;cloudfront:UpdateDistribution&#34;</span>
</span></span><span style="display:flex;"><span>			],
</span></span><span style="display:flex;"><span>			<span style="color:#8839ef">&#34;Resource&#34;</span>: <span style="color:#40a02b">&#34;arn:aws:cloudfront::752286769980:distribution/E24SMKXCSWYBG0&#34;</span>
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#8839ef">&#34;Effect&#34;</span>: <span style="color:#40a02b">&#34;Allow&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#8839ef">&#34;Action&#34;</span>: [
</span></span><span style="display:flex;"><span>				<span style="color:#40a02b">&#34;logs:CreateLogGroup&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#40a02b">&#34;logs:CreateLogStream&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#40a02b">&#34;logs:PutLogEvents&#34;</span>
</span></span><span style="display:flex;"><span>			],
</span></span><span style="display:flex;"><span>			<span style="color:#8839ef">&#34;Resource&#34;</span>: <span style="color:#40a02b">&#34;arn:aws:logs:us-east-1:752286769980:log-group:/aws/lambda/CloudFrontTrafficManagement:*&#34;</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>After you create this role, attach it to your lambda function.</p>
<p><img src="screenshots/lambda-4.png" alt=""></p>
<p>Now, we need to define resource-based policy to the Lambda function that allows SNS to invoke it, by setting SNS as the principal. (Because SNS message is what invokes lambda, not cloudwatch)</p>
<p>Go to the SNS console, and find your topic.</p>
<p><img src="screenshots/lambda-5.png" alt=""></p>
<p>We&rsquo;re going to create a subscription for lambda.</p>
<p><img src="screenshots/lambda-6.png" alt=""></p>
<p>Now, go back to the lambda function, and go to &ldquo;Configurations&rdquo; tab, and scroll down to &ldquo;Resource-based policy statements&rdquo;, and click &ldquo;add permissions&rdquo;.</p>
<p><img src="screenshots/lambda-7.png" alt=""></p>
<p>Then fill in the inputs like so.</p>
<p><img src="screenshots/lambda-8.png" alt=""></p>
<p>Now our lambda function can talk to CloudFront &amp; CloudWatch Logs, as well as be invoked by an SNS topic. Next, we&rsquo;re going to set up CloudWatch alarm, to send message to SNS.</p>
<p>Go to Cloudwatch console, and create an alarm. Make sure you&rsquo;re in us-east-1 region, the same one where CloudFront is deployed.</p>
<p>Click &ldquo;Select metric&rdquo; and we&rsquo;ll select CloudFront -&gt; Per Distribution Metrics -&gt; Requests.</p>
<p><img src="screenshots/cw-1.png" alt=""></p>
<p>I&rsquo;ve set the threshold to be 10+ average requests in 5 minute windows. Feel free to play with the metrics to see which one you like best. Make sure to set &ldquo;Treat missing data as good&rdquo; in the additional setting, because no traffic is good for us.</p>
<p><img src="screenshots/cw-2.png" alt=""></p>
<p>Then on the next screen, we&rsquo;re going to add 2 notifications, one for &ldquo;In alarm&rdquo;, and one for &ldquo;OK&rdquo;. Send them both to the SNS topic we created earlier.</p>
<p><img src="screenshots/cw-3.png" alt=""></p>
<p>Then give the alarm a name, and finish creating it. You should see something like this in the alarm page.</p>
<p><img src="screenshots/cw-4.png" alt=""></p>
<p>With everything set up, all we have to do is test the alarm functionality. Right now, the traffic is normal.</p>
<p><img src="screenshots/test-1.png" alt=""></p>
<p>To trigger the alarm, I&rsquo;m going to go into my CloudFront url <code>static-site.jiwanheo.xyz</code> and hit refresh a bunch of times. After a few minutes, my alarm goes to &ldquo;In alarm&rdquo; state</p>
<p><img src="screenshots/test-2.png" alt=""></p>
<p>And I&rsquo;m not able to access the URL.</p>
<p><img src="screenshots/test-3.png" alt=""></p>
<p>Also, I got an email notification.</p>
<p><img src="screenshots/test-4.png" alt=""></p>
<p>Great! We confirmed that the change in alarm state sent a message to SNS, which invoked a Lambda function to disable CloudFront distribution. Now let&rsquo;s wait a few minutes for the traffic to go back to normal.</p>
<p>And sure enough, we&rsquo;re back to OK state.</p>
<p><img src="screenshots/test-5.png" alt=""></p>
<p>We&rsquo;re able to access the CloudFront URL again</p>
<p><img src="screenshots/test-6.png" alt=""></p>
<p>As well as an email notification.</p>
<p><img src="screenshots/test-7.png" alt=""></p>
<h3 id="section-wrap-up-2">Section Wrap-up</h3>
<p>Here&rsquo;s what we did in this section:</p>
<p><strong>SSL certificate</strong> to enable in-flight encryption</p>
<p><strong>CloudFront CDN distribution</strong> to reduce latency for users around the world</p>
<ul>
<li>Associated CloudFront distribution with a Route 53 A record for easy access</li>
<li>Took S3 bucket private, and set up bucket policy to allow only the CloudFront distribution to talk to it</li>
</ul>
<p>CloudWatch to <strong>monitor traffic</strong></p>
<ul>
<li>Alarm sent to SNS</li>
<li>Email notification</li>
<li>Lambda function to disable/enable CloudFront distribution</li>
</ul>
<p>Hosting a simple static website can become far more engaging with thoughtful enhancements like these. We&rsquo;ve covered all the features I wanted to discuss in this section. Next, we&rsquo;ll take everything we&rsquo;ve set up manually in the AWS Management Console and translate it into code for better reproducibility and scalability.</p>
<h2 id="phase-4">Phase 4</h2>
<p>CloudFormation is AWS&rsquo;s native Infrastructure as Code (IaC) tool that enables you to provision and manage resources by simply declaring the desired end state. In this section, we’ll create a YAML template that defines the AWS resources we want to deploy.</p>
<p>Once the template is ready, we’ll upload it to GitHub and set up a CI/CD pipeline to automatically trigger updates to AWS whenever changes are pushed to the repository. This approach ensures a streamlined, automated, and version-controlled infrastructure deployment process.</p>
<p>Before we start, I&rsquo;m going to delete everything we have and start from scratch. I&rsquo;m going to be deleting (in order)</p>
<ul>
<li><code>lambda-cloudfront-demo</code> IAM role</li>
<li><code>CloudFrontTrafficManagement</code> lambda function</li>
<li><code>static-site-high-requests</code> SNS topic and the subscriptions</li>
<li><code>CF High traffic</code> CloudWatch Alarm</li>
<li><code>static-site.jiwanheo.xyz</code> Route 53 A record</li>
<li><code>_0ed4519312c1991fbbe026f69371e6f0.static-site.jiwanheo.xyz</code> Route 53 CNAME record</li>
<li><code>5511c21e-4e94-41b3-9b2e-f467f3a8ee13</code> ACM cert (You&rsquo;ll have to de-associate it from cloudfront)</li>
<li><code>E24SMKXCSWYBG0</code> CloudFront Distribution (might need to wait a little bit for the DNS change to propagate)</li>
<li><code>static-site.jiwanheo.xyz</code> S3 bucket</li>
</ul>
<p>Now that we&rsquo;re starting from a blank canvas, here&rsquo;s our plan for this phase</p>
<ol>
<li>Create an empty S3 bucket named &ldquo;static-site.jiwanheo.xyz&rdquo;, and set CI/CD to move our app there. (Like we did before)</li>
<li>Set up SSL cert</li>
<li>Set up CloudFront and associate it with an A record</li>
<li>Create SNS topic</li>
<li>Create Lambda function, set it up with CloudFront and SNS</li>
<li>Set up CloudWatch alarm to send messages to SNS</li>
</ol>
<h3 id="step-1-s3-bucket">Step 1. S3 bucket</h3>
<p>Set up an &ldquo;infra&rdquo; directory in our repo. This is where we&rsquo;ll store our YAML files that define our resources. In it, I&rsquo;m going to create my first resource, the S3 bucket, by making &ldquo;s3bucket.yml&rdquo;</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">Resources</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">S3ForStaticSite</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::S3::Bucket
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">BucketName</span>: static-site.jiwanheo.xyz
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">VersioningConfiguration</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Status</span>: Enabled <span style="color:#9ca0b0;font-style:italic"># Enable versioning if needed</span>
</span></span></code></pre></div><p>Also, in the .github/workflows folder, I&rsquo;ll make a new &ldquo;deply-cloudformation.yml&rdquo; to deploy IaC resources.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">name</span>: Deploy CloudFormation Stack
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">on</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">push</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">branches</span>:
</span></span><span style="display:flex;"><span>      - phase4 <span style="color:#9ca0b0;font-style:italic"># Triggers on pushes to the phase4 branch</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">jobs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">deploy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">runs-on</span>: ubuntu-latest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">steps</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#9ca0b0;font-style:italic"># Step 1: Checkout the code</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#8839ef">name</span>: Checkout code
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">uses</span>: actions/checkout@v3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#9ca0b0;font-style:italic"># Step 2: Configure AWS Credentials</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#8839ef">name</span>: Configure AWS credentials
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">uses</span>: aws-actions/configure-aws-credentials@v2
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">with</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">aws-access-key-id</span>: ${{ secrets.AWS_ACCESS_KEY_ID }}
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">aws-secret-access-key</span>: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">aws-region</span>: us-east-1 <span style="color:#9ca0b0;font-style:italic"># Replace with your desired region</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#9ca0b0;font-style:italic"># Step 3: Deploy CloudFormation Stack</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#8839ef">name</span>: Deploy CloudFormation stack
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">run</span>: |<span style="color:#9ca0b0">
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">          aws cloudformation deploy \
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">            --template-file infra/s3bucket.yml \
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">            --stack-name MyS3BucketStack \
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">            --capabilities CAPABILITY_NAMED_IAM</span>          
</span></span></code></pre></div><p>Push up the changes to Github, and it should pick up on this file, to make an S3 bucket.</p>
<p><img src="screenshots/cf-s3-1.png" alt=""></p>
<p>Now is a good time to change the <code>deploy.yml</code>&rsquo;s name to <code>deploy-app.yml</code> and change the target branch to <code>phase4</code> for testing. This should load the S3 bucket with the contents from the <code>out</code> folder.</p>
<p><img src="screenshots/cf-s3-2.png" alt=""></p>
<h3 id="step-2-ssl-cert">Step 2. SSL cert</h3>
<p>Last time when we did it in the console, we requested a cert, and copy/pasted the CNAME Name and value. The process remains the same, but we&rsquo;re going to automate this with Lambda this time. We&rsquo;ll write Python for the lambda function, and store the code in a separate S3 bucket, which Lambda will then read.</p>
<p>In our s3bucket.yml, add one more S3 bucket named <code>S3ForLambda</code>, with the exact same settings as the previous bucket.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">Resources</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">S3ForStaticSite</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::S3::Bucket
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">BucketName</span>: static-site.jiwanheo.xyz
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">VersioningConfiguration</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Status</span>: Enabled <span style="color:#9ca0b0;font-style:italic"># Enable versioning if needed</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">S3ForLambda</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::S3::Bucket
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">BucketName</span>: lambda-for-static-site.jiwanheo.xyz
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">VersioningConfiguration</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Status</span>: Enabled <span style="color:#9ca0b0;font-style:italic"># Enable versioning if needed</span>
</span></span></code></pre></div><p>Then, create another file under <code>infra</code> called <code>sslcert.yml</code>. We&rsquo;ll be setting up 3 resources here. An IAM role for Lambda to communicate to other AWS services, the lambda function itself, and the ACM cert that lambda will create.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">Resources</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic"># IAM Role for the Lambda Function</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">CustomACMLambdaExecutionRole</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::IAM::Role
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic"># Lambda Function to Handle ACM Validation</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">CustomACMLambdaFunction</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::Lambda::Function
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic"># Custom ACM Certificate Resource</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">MyACMCertificate</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: <span style="color:#40a02b">&#34;Custom::ACM&#34;</span>
</span></span></code></pre></div><p><strong>CustomACMLambdaExecutionRole</strong></p>
<p>Lambda will need to talk to 4 services:</p>
<ul>
<li><strong>ACM &amp; Route 53</strong>, to request cert and validate</li>
<li><strong>S3 bucket</strong> to read the Python code</li>
<li><strong>CloudWatch Logs</strong> to write logs</li>
</ul>
<p>Here&rsquo;s the first part, of declaring a role, which is very standard practice to define Lambda as the principal.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">CustomACMLambdaExecutionRole</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Type</span>: AWS::IAM::Role
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">AssumeRolePolicyDocument</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#8839ef">Effect</span>: Allow
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Principal</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Service</span>: lambda.amazonaws.com
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Action</span>: sts:AssumeRole
</span></span></code></pre></div><p>Then for ACM &amp; Route 53, we define the actions that we need lambda to invoke.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span>- <span style="color:#8839ef">PolicyName</span>: LambdaACMRoute53AccessPolicy
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">PolicyDocument</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#8839ef">Effect</span>: Allow
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Action</span>:
</span></span><span style="display:flex;"><span>          - acm:RequestCertificate
</span></span><span style="display:flex;"><span>          - acm:DescribeCertificate
</span></span><span style="display:flex;"><span>          - acm:DeleteCertificate
</span></span><span style="display:flex;"><span>          - acm:ListCertificates
</span></span><span style="display:flex;"><span>          - route53:ChangeResourceRecordSets
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Resource</span>: <span style="color:#40a02b">&#34;*&#34;</span>
</span></span></code></pre></div><p>For S3, we just need it to be able to read the Python code in the bucket.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span>- <span style="color:#8839ef">PolicyName</span>: LambdaS3AccessPolicy
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">PolicyDocument</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#8839ef">Effect</span>: Allow
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Action</span>:
</span></span><span style="display:flex;"><span>          - s3:GetObject
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Resource</span>: <span style="color:#40a02b">&#34;arn:aws:s3:::lambda-for-static-site.jiwanheo.xyz/*&#34;</span>
</span></span></code></pre></div><p>For CloudWatch, we need it to be able to write logs. Logs are crucial for debugging, so please don&rsquo;t skip them!</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span>- <span style="color:#8839ef">PolicyName</span>: LambdaCloudWatchLogsPolicy
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">PolicyDocument</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#8839ef">Effect</span>: Allow
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Action</span>:
</span></span><span style="display:flex;"><span>          - logs:CreateLogGroup
</span></span><span style="display:flex;"><span>          - logs:CreateLogStream
</span></span><span style="display:flex;"><span>          - logs:PutLogEvents
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Resource</span>: <span style="color:#40a02b">&#34;arn:aws:logs:*:*:*&#34;</span>
</span></span></code></pre></div><p>Putting that all together, we&rsquo;ve defined the role that Lambda needs to have.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"># IAM Role for the Lambda Function</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">CustomACMLambdaExecutionRole</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::IAM::Role
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">AssumeRolePolicyDocument</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#8839ef">Effect</span>: Allow
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Principal</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#8839ef">Service</span>: lambda.amazonaws.com
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Action</span>: sts:AssumeRole
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Policies</span>: <span style="color:#9ca0b0;font-style:italic"># This is a list of policy documents</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#8839ef">PolicyName</span>: LambdaACMRoute53AccessPolicy
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">PolicyDocument</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#8839ef">Effect</span>: Allow
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">Action</span>:
</span></span><span style="display:flex;"><span>                  - acm:RequestCertificate
</span></span><span style="display:flex;"><span>                  - acm:DescribeCertificate
</span></span><span style="display:flex;"><span>                  - acm:DeleteCertificate
</span></span><span style="display:flex;"><span>                  - acm:ListCertificates
</span></span><span style="display:flex;"><span>                  - route53:ChangeResourceRecordSets
</span></span><span style="display:flex;"><span>                  - route53:GetChange
</span></span><span style="display:flex;"><span>                  - route53:ListResourceRecordSets
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">Resource</span>: <span style="color:#40a02b">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#8839ef">PolicyName</span>: LambdaS3AccessPolicy
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">PolicyDocument</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#8839ef">Effect</span>: Allow
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">Action</span>:
</span></span><span style="display:flex;"><span>                  - s3:GetObject
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">Resource</span>: <span style="color:#40a02b">&#34;arn:aws:s3:::lambda-for-static-site.jiwanheo.xyz/*&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        - <span style="color:#8839ef">PolicyName</span>: LambdaCloudWatchLogsPolicy
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">PolicyDocument</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#8839ef">Effect</span>: Allow
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">Action</span>:
</span></span><span style="display:flex;"><span>                  - logs:CreateLogGroup
</span></span><span style="display:flex;"><span>                  - logs:CreateLogStream
</span></span><span style="display:flex;"><span>                  - logs:PutLogEvents
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">Resource</span>: <span style="color:#40a02b">&#34;arn:aws:logs:*:*:*&#34;</span>
</span></span></code></pre></div><p><strong>CustomACMLambdaFunction</strong></p>
<p>Now that we have the IAM role that Lambda needs, we can go ahead and actually create the Lambda function, and assign it the role we just created. There&rsquo;s nothing too special about this, the only thing to note, is that the we&rsquo;ll be uploading the Python code as a zip file to the S3 bucket.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"># Lambda Function to Handle ACM Validation</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">CustomACMLambdaFunction</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::Lambda::Function
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Handler</span>: lambda_function.lambda_handler
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Runtime</span>: python3.13
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Code</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">S3Bucket</span>: lambda-for-static-site.jiwanheo.xyz
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">S3Key</span>: lambda_function.zip
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Timeout</span>: <span style="color:#fe640b">300</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Role</span>: !GetAtt CustomACMLambdaExecutionRole.Arn
</span></span></code></pre></div><p>In your <code>deploy-cloudformation.yml</code>, let&rsquo;s add a fourth step to zip up the Python code (which we haven&rsquo;t written yet. We&rsquo;ll write that after defining all the resources first), and upload it to the S3 bucket.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"># Step 4: Set up lambda function</span>
</span></span><span style="display:flex;"><span>- <span style="color:#8839ef">name</span>: Package and Upload Lambda Code
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">run</span>: |<span style="color:#9ca0b0">
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">    cd infra/lambda
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">    zip -r lambda_function.zip lambda_function.py
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">    aws s3 cp lambda_function.zip s3://lambda-for-static-site.jiwanheo.xyz/lambda_function.zip</span>    
</span></span></code></pre></div><p><strong>MyACMCertificate</strong></p>
<p>This step is also pretty simple. We&rsquo;re defining a <em>custom</em> resource that is created by invoking <code>CustomACMLambdaFunction</code>. Custom resource means we&rsquo;re handling the creation/update/deletion, instead of AWS. The <code>Properties</code> we define here, will be included in the <code>event</code> that invokes the lambda function.</p>
<p>A key thing about custom resources, is that we need to handle <em>errors</em> and communication to CloudFormation. If we don&rsquo;t send a response back to CloudFormation about an error, it will hang until custom resource times out after 1 hour.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"># Custom ACM Certificate Resource</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">MyACMCertificate</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: <span style="color:#40a02b">&#34;Custom::ACM&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">ServiceToken</span>: !GetAtt CustomACMLambdaFunction.Arn
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">DomainName</span>: static-site.jiwanheo.xyz
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">HostedZoneId</span>: Z066358329E65RHIEOJXQ
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Region</span>: us-east-1
</span></span></code></pre></div><p>That&rsquo;s it for resources! Putting them all together, my <code>sslcert.yml</code> should look like this. At the end, I added the &ldquo;Output&rdquo; block, so that other resources can access the cert we created.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">Description</span>: Deploy ACM Certificate with DNS Validation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">Resources</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic"># IAM Role for the Lambda Function</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">CustomACMLambdaExecutionRole</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::IAM::Role
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">AssumeRolePolicyDocument</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#8839ef">Effect</span>: Allow
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Principal</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#8839ef">Service</span>: lambda.amazonaws.com
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Action</span>: sts:AssumeRole
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Policies</span>: <span style="color:#9ca0b0;font-style:italic"># This is a list of policy documents</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#8839ef">PolicyName</span>: LambdaACMRoute53AccessPolicy
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">PolicyDocument</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#8839ef">Effect</span>: Allow
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">Action</span>:
</span></span><span style="display:flex;"><span>                  - acm:RequestCertificate
</span></span><span style="display:flex;"><span>                  - acm:DescribeCertificate
</span></span><span style="display:flex;"><span>                  - acm:DeleteCertificate
</span></span><span style="display:flex;"><span>                  - acm:ListCertificates
</span></span><span style="display:flex;"><span>                  - route53:ChangeResourceRecordSets
</span></span><span style="display:flex;"><span>                  - route53:GetChange
</span></span><span style="display:flex;"><span>                  - route53:ListResourceRecordSets
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">Resource</span>: <span style="color:#40a02b">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#8839ef">PolicyName</span>: LambdaS3AccessPolicy
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">PolicyDocument</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#8839ef">Effect</span>: Allow
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">Action</span>:
</span></span><span style="display:flex;"><span>                  - s3:GetObject
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">Resource</span>: <span style="color:#40a02b">&#34;arn:aws:s3:::lambda-for-static-site.jiwanheo.xyz/*&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        - <span style="color:#8839ef">PolicyName</span>: LambdaCloudWatchLogsPolicy
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">PolicyDocument</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#8839ef">Effect</span>: Allow
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">Action</span>:
</span></span><span style="display:flex;"><span>                  - logs:CreateLogGroup
</span></span><span style="display:flex;"><span>                  - logs:CreateLogStream
</span></span><span style="display:flex;"><span>                  - logs:PutLogEvents
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">Resource</span>: <span style="color:#40a02b">&#34;arn:aws:logs:*:*:*&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic"># Lambda Function to Handle ACM Validation</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">CustomACMLambdaFunction</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::Lambda::Function
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Handler</span>: lambda_function.lambda_handler
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Runtime</span>: python3.13
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Code</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">S3Bucket</span>: lambda-for-static-site.jiwanheo.xyz
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">S3Key</span>: lambda_function.zip
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Timeout</span>: <span style="color:#fe640b">300</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Role</span>: !GetAtt CustomACMLambdaExecutionRole.Arn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic"># Custom ACM Certificate Resource</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">MyACMCertificate</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: <span style="color:#40a02b">&#34;Custom::ACM&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">ServiceToken</span>: !GetAtt CustomACMLambdaFunction.Arn
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">DomainName</span>: static-site.jiwanheo.xyz
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">HostedZoneId</span>: Z066358329E65RHIEOJXQ
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Region</span>: us-east-1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">Outputs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">CertificateArn</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Value</span>: !GetAtt MyACMCertificate.CertificateArn
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Export</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Name</span>: MySSLCertificateStack-CertificateArn
</span></span></code></pre></div><p>Now the Python code that makes up the Lambda function.</p>
<p>In your <code>infra</code> folder, create another folder called <code>lambda</code>, and create <code>lambda_function.py</code> in it.</p>
<p>Let&rsquo;s start with dependencies and setup. We&rsquo;re setting up a logger, ACM &amp; Route 53 client, as well as a PoolManager to send HTTP requests to CloudFormation.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#179299">import</span> <span style="color:#fe640b">json</span>
</span></span><span style="display:flex;"><span><span style="color:#179299">import</span> <span style="color:#fe640b">boto3</span>
</span></span><span style="display:flex;"><span><span style="color:#179299">import</span> <span style="color:#fe640b">time</span>
</span></span><span style="display:flex;"><span><span style="color:#179299">import</span> <span style="color:#fe640b">logging</span>
</span></span><span style="display:flex;"><span><span style="color:#179299">import</span> <span style="color:#fe640b">urllib3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"># Set up logging</span>
</span></span><span style="display:flex;"><span>logger <span style="color:#04a5e5;font-weight:bold">=</span> logging<span style="color:#04a5e5;font-weight:bold">.</span>getLogger()
</span></span><span style="display:flex;"><span>logger<span style="color:#04a5e5;font-weight:bold">.</span>setLevel(logging<span style="color:#04a5e5;font-weight:bold">.</span>INFO)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"># Boto3 clients</span>
</span></span><span style="display:flex;"><span>acm_client <span style="color:#04a5e5;font-weight:bold">=</span> boto3<span style="color:#04a5e5;font-weight:bold">.</span>client(<span style="color:#40a02b">&#39;acm&#39;</span>)
</span></span><span style="display:flex;"><span>route53_client <span style="color:#04a5e5;font-weight:bold">=</span> boto3<span style="color:#04a5e5;font-weight:bold">.</span>client(<span style="color:#40a02b">&#39;route53&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"># Initialize the urllib3 PoolManager</span>
</span></span><span style="display:flex;"><span>http <span style="color:#04a5e5;font-weight:bold">=</span> urllib3<span style="color:#04a5e5;font-weight:bold">.</span>PoolManager()
</span></span></code></pre></div><p>Our goal is to make a <code>def lambda_handler(event, context)</code> function that creates an ACM certification, and validate it via registering a CNAME DNS record.</p>
<p>There&rsquo;s lots of helper functions and moving parts. Here is an overview of all the functions that we&rsquo;ll be creating.</p>
<ul>
<li><code>lambda_handler</code>
<ul>
<li>The main function that will orchestrate the whole process</li>
</ul>
</li>
<li><code>send_response</code>
<ul>
<li>Tell CloudFormation if we&rsquo;re successful or not at creating/validating ACM cert.</li>
<li>This step is SUPER important, as written above, without it, CloudFormation will go into an endless loop, waiting for the confirmation from us.</li>
</ul>
</li>
<li><code>create_dns_record</code> &amp; <code>delete_dns_record</code>
<ul>
<li>Pretty straight forward functions that uses the route 53 client to interact with DNS.</li>
</ul>
</li>
<li><code>delete_acm_certificate</code>
<ul>
<li>Uses ACM client to delete certificate (for example, when we delete the CloudFormation Stack)</li>
</ul>
</li>
<li><code>wait_and_fetch_cert_resource_record</code>
<ul>
<li>After we request the cert, it may take some time to receive the response. This function is simply a re-try mechanism.</li>
</ul>
</li>
</ul>
<p>This is the big structure for <code>lambda_handler</code>. The whole thing is wrapped in a Try/Except block, where the except block sends request to cloudformation that we &ldquo;FAILED&rdquo;.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8839ef">def</span> <span style="color:#1e66f5">lambda_handler</span>(event, context):
</span></span><span style="display:flex;"><span>    <span style="color:#40a02b">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    Lambda function to handle ACM certificate DNS validation via Route 53.
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#9ca0b0;font-style:italic"># Log the received event for debugging</span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Received event: </span><span style="color:#40a02b">{</span>json<span style="color:#04a5e5;font-weight:bold">.</span>dumps(event)<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">except</span> <span style="color:#fe640b">Exception</span> <span style="color:#8839ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#04a5e5;font-weight:bold">.</span>error(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Error processing validation: </span><span style="color:#40a02b">{</span><span style="color:#04a5e5">str</span>(e)<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>, exc_info<span style="color:#04a5e5;font-weight:bold">=</span><span style="color:#fe640b">True</span>)
</span></span><span style="display:flex;"><span>        send_response(
</span></span><span style="display:flex;"><span>            event,
</span></span><span style="display:flex;"><span>            context,
</span></span><span style="display:flex;"><span>            response_status <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#40a02b">&#39;FAILED&#39;</span>,
</span></span><span style="display:flex;"><span>            response_data <span style="color:#04a5e5;font-weight:bold">=</span> {<span style="color:#40a02b">&#39;Message&#39;</span>: <span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Error: </span><span style="color:#40a02b">{</span><span style="color:#04a5e5">str</span>(e)<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>}
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">return</span> {<span style="color:#40a02b">&#39;statusCode&#39;</span>: <span style="color:#fe640b">500</span>, <span style="color:#40a02b">&#39;body&#39;</span>: json<span style="color:#04a5e5;font-weight:bold">.</span>dumps(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Error: </span><span style="color:#40a02b">{</span><span style="color:#04a5e5">str</span>(e)<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)}
</span></span></code></pre></div><p>Now, going to <code>send_response</code>, the first two arguments are what lambda function is invoked with by CloudFormation, while the 3rd/4th arguments are the status and failure/success messages that we generate.</p>
<p><code>physical_resource_id</code> is an interesting one. When we call <code>send_reponse</code> to deliver a &ldquo;SUCCESS&rdquo; message, we&rsquo;ll be passing in the arn of the certificate, to associate the response we make with the certificate. In case of sending a &ldquo;FAILED&rdquo; message, we won&rsquo;t pass in any value, because none was created/updated and <code>context.log_stream_name</code> will be used in its place (just the CloudWatch log stream name for debugging purpose).</p>
<p>The response_url is the destination (cloudformation), pulled from the event, and response_body is a collection of the info that we descussed. We&rsquo;ll use these information to make a PUT request.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8839ef">def</span> <span style="color:#1e66f5">send_response</span>(event, context, response_status, response_data, physical_resource_id<span style="color:#04a5e5;font-weight:bold">=</span><span style="color:#fe640b">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#40a02b">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    Sends a response to CloudFormation indicating success or failure.
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic"># Use provided PhysicalResourceId or default to log_stream_name</span>
</span></span><span style="display:flex;"><span>    physical_resource_id <span style="color:#04a5e5;font-weight:bold">=</span> physical_resource_id <span style="color:#04a5e5;font-weight:bold">or</span> context<span style="color:#04a5e5;font-weight:bold">.</span>log_stream_name
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    response_url <span style="color:#04a5e5;font-weight:bold">=</span> event[<span style="color:#40a02b">&#39;ResponseURL&#39;</span>]
</span></span><span style="display:flex;"><span>    response_body <span style="color:#04a5e5;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#40a02b">&#39;Status&#39;</span>: response_status,
</span></span><span style="display:flex;"><span>        <span style="color:#40a02b">&#39;Reason&#39;</span>: <span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Details in CloudWatch Log Stream: </span><span style="color:#40a02b">{</span>context<span style="color:#04a5e5;font-weight:bold">.</span>log_stream_name<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#40a02b">&#39;PhysicalResourceId&#39;</span>: physical_resource_id,
</span></span><span style="display:flex;"><span>        <span style="color:#40a02b">&#39;StackId&#39;</span>: event[<span style="color:#40a02b">&#39;StackId&#39;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#40a02b">&#39;RequestId&#39;</span>: event[<span style="color:#40a02b">&#39;RequestId&#39;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#40a02b">&#39;LogicalResourceId&#39;</span>: event[<span style="color:#40a02b">&#39;LogicalResourceId&#39;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#40a02b">&#39;Data&#39;</span>: response_data
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic"># Convert the dictionary to JSON</span>
</span></span><span style="display:flex;"><span>    encoded_body <span style="color:#04a5e5;font-weight:bold">=</span> json<span style="color:#04a5e5;font-weight:bold">.</span>dumps(response_body)<span style="color:#04a5e5;font-weight:bold">.</span>encode(<span style="color:#40a02b">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">try</span>:
</span></span><span style="display:flex;"><span>        response <span style="color:#04a5e5;font-weight:bold">=</span> http<span style="color:#04a5e5;font-weight:bold">.</span>request(
</span></span><span style="display:flex;"><span>            <span style="color:#40a02b">&#39;PUT&#39;</span>,
</span></span><span style="display:flex;"><span>            response_url,
</span></span><span style="display:flex;"><span>            body<span style="color:#04a5e5;font-weight:bold">=</span>encoded_body,
</span></span><span style="display:flex;"><span>            headers<span style="color:#04a5e5;font-weight:bold">=</span>{<span style="color:#40a02b">&#39;Content-Type&#39;</span>: <span style="color:#40a02b">&#39;application/json&#39;</span>}
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Sending to CloudFormation response: </span><span style="color:#40a02b">{</span>response_status<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">return</span> response
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">except</span> <span style="color:#fe640b">Exception</span> <span style="color:#8839ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#04a5e5;font-weight:bold">.</span>error(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Failed to send response to CloudFormation: </span><span style="color:#40a02b">{</span><span style="color:#04a5e5">str</span>(e)<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span></code></pre></div><p>Ok, let&rsquo;s fill in the next part of the <code>lambda_handler</code>. We&rsquo;ll extract a few information from the event, and early fail the function if those information is not present. When we do so, we send the response back to cloudformation, and our function will return a message as well. After that, we define two behaviours for resource creation/update &amp; deletion in an if block.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8839ef">def</span> <span style="color:#1e66f5">lambda_handler</span>(event, context):
</span></span><span style="display:flex;"><span>    <span style="color:#40a02b">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    Lambda function to handle ACM certificate DNS validation via Route 53.
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#9ca0b0;font-style:italic"># Log the received event for debugging</span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Received event: </span><span style="color:#40a02b">{</span>json<span style="color:#04a5e5;font-weight:bold">.</span>dumps(event)<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#9ca0b0;font-style:italic"># Extract parameters from the event</span>
</span></span><span style="display:flex;"><span>        props <span style="color:#04a5e5;font-weight:bold">=</span> event<span style="color:#04a5e5;font-weight:bold">.</span>get(<span style="color:#40a02b">&#39;ResourceProperties&#39;</span>, {})
</span></span><span style="display:flex;"><span>        domain_name <span style="color:#04a5e5;font-weight:bold">=</span> props<span style="color:#04a5e5;font-weight:bold">.</span>get(<span style="color:#40a02b">&#39;DomainName&#39;</span>)
</span></span><span style="display:flex;"><span>        hosted_zone_id <span style="color:#04a5e5;font-weight:bold">=</span> props<span style="color:#04a5e5;font-weight:bold">.</span>get(<span style="color:#40a02b">&#39;HostedZoneId&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#9ca0b0;font-style:italic"># Early fail, if missing properties</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">if</span> <span style="color:#04a5e5;font-weight:bold">not</span> <span style="color:#04a5e5">all</span>([domain_name, hosted_zone_id]):
</span></span><span style="display:flex;"><span>            error_message <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#40a02b">&#34;Missing one or more required properties.&#34;</span>
</span></span><span style="display:flex;"><span>            logger<span style="color:#04a5e5;font-weight:bold">.</span>error(error_message)
</span></span><span style="display:flex;"><span>            send_response(
</span></span><span style="display:flex;"><span>                event,
</span></span><span style="display:flex;"><span>                context,
</span></span><span style="display:flex;"><span>                response_status <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#40a02b">&#39;FAILED&#39;</span>,
</span></span><span style="display:flex;"><span>                response_data <span style="color:#04a5e5;font-weight:bold">=</span> {<span style="color:#40a02b">&#39;Message&#39;</span>: error_message}
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">return</span> {<span style="color:#40a02b">&#39;statusCode&#39;</span>: <span style="color:#fe640b">500</span>, <span style="color:#40a02b">&#39;body&#39;</span>: error_message}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#9ca0b0;font-style:italic"># CREATE/UPDATE share same code, and DELETE has its own block</span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Processing </span><span style="color:#40a02b">{</span>event[<span style="color:#40a02b">&#39;RequestType&#39;</span>]<span style="color:#40a02b">}</span><span style="color:#40a02b"> request for domain: </span><span style="color:#40a02b">{</span>domain_name<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">if</span> event[<span style="color:#40a02b">&#39;RequestType&#39;</span>] <span style="color:#04a5e5;font-weight:bold">in</span> [<span style="color:#40a02b">&#39;Create&#39;</span>, <span style="color:#40a02b">&#39;Update&#39;</span>]:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">elif</span> event[<span style="color:#40a02b">&#39;RequestType&#39;</span>] <span style="color:#04a5e5;font-weight:bold">==</span> <span style="color:#40a02b">&#39;Delete&#39;</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">except</span> <span style="color:#fe640b">Exception</span> <span style="color:#8839ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#04a5e5;font-weight:bold">.</span>error(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Error processing validation: </span><span style="color:#40a02b">{</span><span style="color:#04a5e5">str</span>(e)<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>, exc_info<span style="color:#04a5e5;font-weight:bold">=</span><span style="color:#fe640b">True</span>)
</span></span><span style="display:flex;"><span>        send_response(
</span></span><span style="display:flex;"><span>            event,
</span></span><span style="display:flex;"><span>            context,
</span></span><span style="display:flex;"><span>            response_status <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#40a02b">&#39;FAILED&#39;</span>,
</span></span><span style="display:flex;"><span>            response_data <span style="color:#04a5e5;font-weight:bold">=</span> {<span style="color:#40a02b">&#39;Message&#39;</span>: <span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Error: </span><span style="color:#40a02b">{</span><span style="color:#04a5e5">str</span>(e)<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>}
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">return</span> {<span style="color:#40a02b">&#39;statusCode&#39;</span>: <span style="color:#fe640b">500</span>, <span style="color:#40a02b">&#39;body&#39;</span>: json<span style="color:#04a5e5;font-weight:bold">.</span>dumps(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Error: </span><span style="color:#40a02b">{</span><span style="color:#04a5e5">str</span>(e)<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)}
</span></span></code></pre></div><p>Doing the create/update first, we have the following code. We first use the information we extracted, to request a new certificate. We extract the arn from the response, and if not present, fail the function (and send response to CloudFormation).</p>
<p>If all&rsquo;s good, we extract the &ldquo;resource record&rdquo; from the certification, which holds the DNS name and value that we need to register. This information may not be available right after we request the certificate, so we build a re-try mechanism with <code>wait_and_fetch_cert_resource_record</code> (code follows right after this block).</p>
<p>After we fetch the Name and Value for the DNS record that needs to be created, we use the Route 53 client to make a DNS record, in a function <code>create_dns_record</code>. (code follows after this block).</p>
<p>Finally, we send SUCCESS response to CloudFormation. It&rsquo;s important to include the CertificateArn in the response_data, so that the stack can output it.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8839ef">if</span> event[<span style="color:#40a02b">&#39;RequestType&#39;</span>] <span style="color:#04a5e5;font-weight:bold">in</span> [<span style="color:#40a02b">&#39;Create&#39;</span>, <span style="color:#40a02b">&#39;Update&#39;</span>]:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  response <span style="color:#04a5e5;font-weight:bold">=</span> acm_client<span style="color:#04a5e5;font-weight:bold">.</span>request_certificate(
</span></span><span style="display:flex;"><span>      DomainName<span style="color:#04a5e5;font-weight:bold">=</span>domain_name,
</span></span><span style="display:flex;"><span>      ValidationMethod<span style="color:#04a5e5;font-weight:bold">=</span><span style="color:#40a02b">&#39;DNS&#39;</span>,
</span></span><span style="display:flex;"><span>      SubjectAlternativeNames<span style="color:#04a5e5;font-weight:bold">=</span>[domain_name],
</span></span><span style="display:flex;"><span>      Options<span style="color:#04a5e5;font-weight:bold">=</span>{<span style="color:#40a02b">&#39;CertificateTransparencyLoggingPreference&#39;</span>: <span style="color:#40a02b">&#39;ENABLED&#39;</span>}
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  certificate_arn <span style="color:#04a5e5;font-weight:bold">=</span> response[<span style="color:#40a02b">&#39;CertificateArn&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic"># Check if CertificateArn is available before proceeding with Create or Update actions</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">if</span> certificate_arn <span style="color:#04a5e5;font-weight:bold">is</span> <span style="color:#fe640b">None</span>:
</span></span><span style="display:flex;"><span>      error_message <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#40a02b">&#34;CertificateArn is missing, cannot proceed with certificate validation.&#34;</span>
</span></span><span style="display:flex;"><span>      logger<span style="color:#04a5e5;font-weight:bold">.</span>error(error_message)
</span></span><span style="display:flex;"><span>      send_response(
</span></span><span style="display:flex;"><span>          event,
</span></span><span style="display:flex;"><span>          context,
</span></span><span style="display:flex;"><span>          response_status <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#40a02b">&#39;FAILED&#39;</span>,
</span></span><span style="display:flex;"><span>          response_data <span style="color:#04a5e5;font-weight:bold">=</span> {<span style="color:#40a02b">&#39;Message&#39;</span>: error_message}
</span></span><span style="display:flex;"><span>      )
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">return</span> {<span style="color:#40a02b">&#39;statusCode&#39;</span>: <span style="color:#fe640b">500</span>, <span style="color:#40a02b">&#39;body&#39;</span>: error_message}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Requested certificate: </span><span style="color:#40a02b">{</span>certificate_arn<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic"># Re-try mechanism here</span>
</span></span><span style="display:flex;"><span>  resource_record <span style="color:#04a5e5;font-weight:bold">=</span> wait_and_fetch_cert_resource_record(acm_client, certificate_arn)
</span></span><span style="display:flex;"><span>  validation_record_name <span style="color:#04a5e5;font-weight:bold">=</span> resource_record[<span style="color:#40a02b">&#39;Name&#39;</span>]
</span></span><span style="display:flex;"><span>  validation_record_value <span style="color:#04a5e5;font-weight:bold">=</span> resource_record[<span style="color:#40a02b">&#39;Value&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic"># Create or update the DNS record for DNS validation</span>
</span></span><span style="display:flex;"><span>  logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;DNS validation record: </span><span style="color:#40a02b">{</span>validation_record_name<span style="color:#40a02b">}</span><span style="color:#40a02b"> -&gt; </span><span style="color:#40a02b">{</span>validation_record_value<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>  create_dns_record(
</span></span><span style="display:flex;"><span>      hosted_zone_id, validation_record_name, validation_record_value
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic"># Send response to CloudFormation (Important!!! without it, it&#39;ll endlessly wait for the response that we never sent)</span>
</span></span><span style="display:flex;"><span>  send_response(
</span></span><span style="display:flex;"><span>      event,
</span></span><span style="display:flex;"><span>      context,
</span></span><span style="display:flex;"><span>      response_status <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#40a02b">&#39;SUCCESS&#39;</span>,
</span></span><span style="display:flex;"><span>      response_data <span style="color:#04a5e5;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#40a02b">&#39;Message&#39;</span>: <span style="color:#40a02b">&#39;ACM Certificate created and validated.&#39;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#40a02b">&#39;CertificateArn&#39;</span>: certificate_arn
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      physical_resource_id<span style="color:#04a5e5;font-weight:bold">=</span>certificate_arn
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">return</span> {<span style="color:#40a02b">&#39;statusCode&#39;</span>: <span style="color:#fe640b">200</span>, <span style="color:#40a02b">&#39;body&#39;</span>: json<span style="color:#04a5e5;font-weight:bold">.</span>dumps(<span style="color:#40a02b">&#39;Validation record processed successfully.&#39;</span>)}
</span></span></code></pre></div><p>Here&rsquo;s <code>wait_and_fetch_cert_resource_record</code>. Nothing special, it keeps trying <code>describe_certificate</code> using the acm client on our certificate, until it&rsquo;s been issued <code>ResourceRecord</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8839ef">def</span> <span style="color:#1e66f5">wait_and_fetch_cert_resource_record</span>(acm_client, certificate_arn, timeout<span style="color:#04a5e5;font-weight:bold">=</span><span style="color:#fe640b">300</span>, interval<span style="color:#04a5e5;font-weight:bold">=</span><span style="color:#fe640b">15</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#40a02b">&#34;&#34;&#34;Wait until the ACM certificate includes the ResourceRecord.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    start_time <span style="color:#04a5e5;font-weight:bold">=</span> time<span style="color:#04a5e5;font-weight:bold">.</span>time()
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">while</span> <span style="color:#fe640b">True</span>:
</span></span><span style="display:flex;"><span>        cert_details <span style="color:#04a5e5;font-weight:bold">=</span> acm_client<span style="color:#04a5e5;font-weight:bold">.</span>describe_certificate(CertificateArn<span style="color:#04a5e5;font-weight:bold">=</span>certificate_arn)
</span></span><span style="display:flex;"><span>        validation_options <span style="color:#04a5e5;font-weight:bold">=</span> cert_details[<span style="color:#40a02b">&#39;Certificate&#39;</span>][<span style="color:#40a02b">&#39;DomainValidationOptions&#39;</span>][<span style="color:#fe640b">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#9ca0b0;font-style:italic"># Check if the ResourceRecord is available</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">if</span> <span style="color:#40a02b">&#39;ResourceRecord&#39;</span> <span style="color:#04a5e5;font-weight:bold">in</span> validation_options:
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">return</span> validation_options[<span style="color:#40a02b">&#39;ResourceRecord&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#9ca0b0;font-style:italic"># Check for timeout</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">if</span> time<span style="color:#04a5e5;font-weight:bold">.</span>time() <span style="color:#04a5e5;font-weight:bold">-</span> start_time <span style="color:#04a5e5;font-weight:bold">&gt;</span> timeout:
</span></span><span style="display:flex;"><span>            logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#40a02b">&#34;Timeout waiting for ACM certificate ResourceRecord. Will try again&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Waiting for ResourceRecord. Current status: </span><span style="color:#40a02b">{</span>validation_options[<span style="color:#40a02b">&#39;ValidationStatus&#39;</span>]<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>        time<span style="color:#04a5e5;font-weight:bold">.</span>sleep(interval)
</span></span></code></pre></div><p>Here&rsquo;s <code>create_dns_record</code>. Nothing special, just using the name/value to UPSERT a CNAME record in our hosted zone.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8839ef">def</span> <span style="color:#1e66f5">create_dns_record</span>(hosted_zone_id, record_name, record_value):
</span></span><span style="display:flex;"><span>    <span style="color:#40a02b">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    Create or update a DNS validation record in Route 53.
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Creating DNS record: </span><span style="color:#40a02b">{</span>record_name<span style="color:#40a02b">}</span><span style="color:#40a02b"> -&gt; </span><span style="color:#40a02b">{</span>record_value<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>    change_batch <span style="color:#04a5e5;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#40a02b">&#39;Changes&#39;</span>: [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#40a02b">&#39;Action&#39;</span>: <span style="color:#40a02b">&#39;UPSERT&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#40a02b">&#39;ResourceRecordSet&#39;</span>: {
</span></span><span style="display:flex;"><span>                    <span style="color:#40a02b">&#39;Name&#39;</span>: record_name,
</span></span><span style="display:flex;"><span>                    <span style="color:#40a02b">&#39;Type&#39;</span>: <span style="color:#40a02b">&#39;CNAME&#39;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#40a02b">&#39;TTL&#39;</span>: <span style="color:#fe640b">60</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#40a02b">&#39;ResourceRecords&#39;</span>: [{<span style="color:#40a02b">&#39;Value&#39;</span>: record_value}]
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    route53_client<span style="color:#04a5e5;font-weight:bold">.</span>change_resource_record_sets(
</span></span><span style="display:flex;"><span>        HostedZoneId<span style="color:#04a5e5;font-weight:bold">=</span>hosted_zone_id,
</span></span><span style="display:flex;"><span>        ChangeBatch<span style="color:#04a5e5;font-weight:bold">=</span>change_batch
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#40a02b">&#34;DNS record created or updated successfully.&#34;</span>)
</span></span></code></pre></div><p>Ok! Now the &ldquo;Delete&rdquo; part of <code>lambda_handler</code>. We&rsquo;ll pull the arn of the cert from the event, and if it doesn&rsquo;t exist, fail it, and send the response back to cloudformation. If all goes well, pull the record name + value (the wait is not necessary, but i used it just because the extracting logic exists there already). We&rsquo;ll use them to delete the DNS record, then use the cert arn to delete the ACM cert. And finally send the response to cloudformation.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8839ef">elif</span> event[<span style="color:#40a02b">&#39;RequestType&#39;</span>] <span style="color:#04a5e5;font-weight:bold">==</span> <span style="color:#40a02b">&#39;Delete&#39;</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">if</span> event[<span style="color:#40a02b">&#39;PhysicalResourceId&#39;</span>] <span style="color:#04a5e5;font-weight:bold">is</span> <span style="color:#fe640b">None</span>:
</span></span><span style="display:flex;"><span>    error_message <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#40a02b">&#34;CertificateArn is missing, cannot proceed with certificate validation.&#34;</span>
</span></span><span style="display:flex;"><span>    logger<span style="color:#04a5e5;font-weight:bold">.</span>error(error_message)
</span></span><span style="display:flex;"><span>    send_response(
</span></span><span style="display:flex;"><span>        event,
</span></span><span style="display:flex;"><span>        context,
</span></span><span style="display:flex;"><span>        response_status <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#40a02b">&#39;FAILED&#39;</span>,
</span></span><span style="display:flex;"><span>        response_data <span style="color:#04a5e5;font-weight:bold">=</span> {<span style="color:#40a02b">&#39;Message&#39;</span>: error_message}
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">return</span> {<span style="color:#40a02b">&#39;statusCode&#39;</span>: <span style="color:#fe640b">500</span>, <span style="color:#40a02b">&#39;body&#39;</span>: error_message}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  certificate_arn <span style="color:#04a5e5;font-weight:bold">=</span> event[<span style="color:#40a02b">&#39;PhysicalResourceId&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  resource_record <span style="color:#04a5e5;font-weight:bold">=</span> wait_and_fetch_cert_resource_record(acm_client, certificate_arn)
</span></span><span style="display:flex;"><span>  validation_record_name <span style="color:#04a5e5;font-weight:bold">=</span> resource_record[<span style="color:#40a02b">&#39;Name&#39;</span>]
</span></span><span style="display:flex;"><span>  validation_record_value <span style="color:#04a5e5;font-weight:bold">=</span> resource_record[<span style="color:#40a02b">&#39;Value&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Deleting DNS record: </span><span style="color:#40a02b">{</span>validation_record_name<span style="color:#40a02b">}</span><span style="color:#40a02b"> -&gt; </span><span style="color:#40a02b">{</span>validation_record_value<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>  delete_dns_record(
</span></span><span style="display:flex;"><span>      hosted_zone_id, validation_record_name, validation_record_value
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Deleting certificate: </span><span style="color:#40a02b">{</span>certificate_arn<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>  delete_acm_certificate(certificate_arn)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  send_response(
</span></span><span style="display:flex;"><span>      event,
</span></span><span style="display:flex;"><span>      context,
</span></span><span style="display:flex;"><span>      response_status <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#40a02b">&#39;SUCCESS&#39;</span>,
</span></span><span style="display:flex;"><span>      response_data <span style="color:#04a5e5;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#40a02b">&#39;Message&#39;</span>: <span style="color:#40a02b">&#34;Validation record and certificate deleted successfully.&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#40a02b">&#39;CertificateArn&#39;</span>: certificate_arn
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      physical_resource_id<span style="color:#04a5e5;font-weight:bold">=</span>certificate_arn
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">return</span> {<span style="color:#40a02b">&#39;statusCode&#39;</span>: <span style="color:#fe640b">200</span>, <span style="color:#40a02b">&#39;body&#39;</span>: json<span style="color:#04a5e5;font-weight:bold">.</span>dumps(<span style="color:#40a02b">&#34;Validation record and certificate deleted successfully.&#34;</span>)}
</span></span></code></pre></div><p>Here&rsquo;s <code>delete_dns_record</code> and <code>delete_acm_certificate</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8839ef">def</span> <span style="color:#1e66f5">delete_dns_record</span>(hosted_zone_id, record_name, record_value):
</span></span><span style="display:flex;"><span>    <span style="color:#40a02b">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    Delete a DNS validation record from Route 53.
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Deleting DNS record: </span><span style="color:#40a02b">{</span>record_name<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>    change_batch <span style="color:#04a5e5;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#40a02b">&#39;Changes&#39;</span>: [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#40a02b">&#39;Action&#39;</span>: <span style="color:#40a02b">&#39;DELETE&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#40a02b">&#39;ResourceRecordSet&#39;</span>: {
</span></span><span style="display:flex;"><span>                    <span style="color:#40a02b">&#39;Name&#39;</span>: record_name,
</span></span><span style="display:flex;"><span>                    <span style="color:#40a02b">&#39;Type&#39;</span>: <span style="color:#40a02b">&#39;CNAME&#39;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#40a02b">&#39;TTL&#39;</span>: <span style="color:#fe640b">60</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#40a02b">&#39;ResourceRecords&#39;</span>: [{<span style="color:#40a02b">&#39;Value&#39;</span>: record_value}]
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    route53_client<span style="color:#04a5e5;font-weight:bold">.</span>change_resource_record_sets(
</span></span><span style="display:flex;"><span>        HostedZoneId<span style="color:#04a5e5;font-weight:bold">=</span>hosted_zone_id,
</span></span><span style="display:flex;"><span>        ChangeBatch<span style="color:#04a5e5;font-weight:bold">=</span>change_batch
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#40a02b">&#34;DNS record deleted successfully.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">def</span> <span style="color:#1e66f5">delete_acm_certificate</span>(certificate_arn):
</span></span><span style="display:flex;"><span>    <span style="color:#40a02b">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    Delete the ACM certificate if it exists and is valid.
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Deleting ACM certificate: </span><span style="color:#40a02b">{</span>certificate_arn<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">try</span>:
</span></span><span style="display:flex;"><span>        acm_client<span style="color:#04a5e5;font-weight:bold">.</span>delete_certificate(CertificateArn<span style="color:#04a5e5;font-weight:bold">=</span>certificate_arn)
</span></span><span style="display:flex;"><span>        logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#40a02b">&#34;ACM certificate deleted successfully.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">except</span> <span style="color:#fe640b">Exception</span> <span style="color:#8839ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#04a5e5;font-weight:bold">.</span>error(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Error deleting ACM certificate: </span><span style="color:#40a02b">{</span><span style="color:#04a5e5">str</span>(e)<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>, exc_info<span style="color:#04a5e5;font-weight:bold">=</span><span style="color:#fe640b">True</span>)
</span></span></code></pre></div><p>OK! We&rsquo;ve covered everything about the <code>lambda_handler</code>. Putting that all together, we have <code>lambda_function.py</code></p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#179299">import</span> <span style="color:#fe640b">json</span>
</span></span><span style="display:flex;"><span><span style="color:#179299">import</span> <span style="color:#fe640b">boto3</span>
</span></span><span style="display:flex;"><span><span style="color:#179299">import</span> <span style="color:#fe640b">time</span>
</span></span><span style="display:flex;"><span><span style="color:#179299">import</span> <span style="color:#fe640b">logging</span>
</span></span><span style="display:flex;"><span><span style="color:#179299">import</span> <span style="color:#fe640b">urllib3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"># Set up logging</span>
</span></span><span style="display:flex;"><span>logger <span style="color:#04a5e5;font-weight:bold">=</span> logging<span style="color:#04a5e5;font-weight:bold">.</span>getLogger()
</span></span><span style="display:flex;"><span>logger<span style="color:#04a5e5;font-weight:bold">.</span>setLevel(logging<span style="color:#04a5e5;font-weight:bold">.</span>INFO)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"># Boto3 clients</span>
</span></span><span style="display:flex;"><span>acm_client <span style="color:#04a5e5;font-weight:bold">=</span> boto3<span style="color:#04a5e5;font-weight:bold">.</span>client(<span style="color:#40a02b">&#39;acm&#39;</span>)
</span></span><span style="display:flex;"><span>route53_client <span style="color:#04a5e5;font-weight:bold">=</span> boto3<span style="color:#04a5e5;font-weight:bold">.</span>client(<span style="color:#40a02b">&#39;route53&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"># Initialize the urllib3 PoolManager</span>
</span></span><span style="display:flex;"><span>http <span style="color:#04a5e5;font-weight:bold">=</span> urllib3<span style="color:#04a5e5;font-weight:bold">.</span>PoolManager()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">def</span> <span style="color:#1e66f5">send_response</span>(event, context, response_status, response_data, physical_resource_id<span style="color:#04a5e5;font-weight:bold">=</span><span style="color:#fe640b">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#40a02b">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    Sends a response to CloudFormation indicating success or failure.
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic"># Use provided PhysicalResourceId or default to log_stream_name</span>
</span></span><span style="display:flex;"><span>    physical_resource_id <span style="color:#04a5e5;font-weight:bold">=</span> physical_resource_id <span style="color:#04a5e5;font-weight:bold">or</span> context<span style="color:#04a5e5;font-weight:bold">.</span>log_stream_name
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    response_url <span style="color:#04a5e5;font-weight:bold">=</span> event[<span style="color:#40a02b">&#39;ResponseURL&#39;</span>]
</span></span><span style="display:flex;"><span>    response_body <span style="color:#04a5e5;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#40a02b">&#39;Status&#39;</span>: response_status,
</span></span><span style="display:flex;"><span>        <span style="color:#40a02b">&#39;Reason&#39;</span>: <span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Details in CloudWatch Log Stream: </span><span style="color:#40a02b">{</span>context<span style="color:#04a5e5;font-weight:bold">.</span>log_stream_name<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#40a02b">&#39;PhysicalResourceId&#39;</span>: physical_resource_id,
</span></span><span style="display:flex;"><span>        <span style="color:#40a02b">&#39;StackId&#39;</span>: event[<span style="color:#40a02b">&#39;StackId&#39;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#40a02b">&#39;RequestId&#39;</span>: event[<span style="color:#40a02b">&#39;RequestId&#39;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#40a02b">&#39;LogicalResourceId&#39;</span>: event[<span style="color:#40a02b">&#39;LogicalResourceId&#39;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#40a02b">&#39;Data&#39;</span>: response_data
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic"># Convert the dictionary to JSON</span>
</span></span><span style="display:flex;"><span>    encoded_body <span style="color:#04a5e5;font-weight:bold">=</span> json<span style="color:#04a5e5;font-weight:bold">.</span>dumps(response_body)<span style="color:#04a5e5;font-weight:bold">.</span>encode(<span style="color:#40a02b">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">try</span>:
</span></span><span style="display:flex;"><span>        response <span style="color:#04a5e5;font-weight:bold">=</span> http<span style="color:#04a5e5;font-weight:bold">.</span>request(
</span></span><span style="display:flex;"><span>            <span style="color:#40a02b">&#39;PUT&#39;</span>,
</span></span><span style="display:flex;"><span>            response_url,
</span></span><span style="display:flex;"><span>            body<span style="color:#04a5e5;font-weight:bold">=</span>encoded_body,
</span></span><span style="display:flex;"><span>            headers<span style="color:#04a5e5;font-weight:bold">=</span>{<span style="color:#40a02b">&#39;Content-Type&#39;</span>: <span style="color:#40a02b">&#39;application/json&#39;</span>}
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Sending to CloudFormation response: </span><span style="color:#40a02b">{</span>response_status<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">return</span> response
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">except</span> <span style="color:#fe640b">Exception</span> <span style="color:#8839ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#04a5e5;font-weight:bold">.</span>error(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Failed to send response to CloudFormation: </span><span style="color:#40a02b">{</span><span style="color:#04a5e5">str</span>(e)<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">def</span> <span style="color:#1e66f5">create_dns_record</span>(hosted_zone_id, record_name, record_value):
</span></span><span style="display:flex;"><span>    <span style="color:#40a02b">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    Create or update a DNS validation record in Route 53.
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Creating DNS record: </span><span style="color:#40a02b">{</span>record_name<span style="color:#40a02b">}</span><span style="color:#40a02b"> -&gt; </span><span style="color:#40a02b">{</span>record_value<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>    change_batch <span style="color:#04a5e5;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#40a02b">&#39;Changes&#39;</span>: [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#40a02b">&#39;Action&#39;</span>: <span style="color:#40a02b">&#39;UPSERT&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#40a02b">&#39;ResourceRecordSet&#39;</span>: {
</span></span><span style="display:flex;"><span>                    <span style="color:#40a02b">&#39;Name&#39;</span>: record_name,
</span></span><span style="display:flex;"><span>                    <span style="color:#40a02b">&#39;Type&#39;</span>: <span style="color:#40a02b">&#39;CNAME&#39;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#40a02b">&#39;TTL&#39;</span>: <span style="color:#fe640b">60</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#40a02b">&#39;ResourceRecords&#39;</span>: [{<span style="color:#40a02b">&#39;Value&#39;</span>: record_value}]
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    route53_client<span style="color:#04a5e5;font-weight:bold">.</span>change_resource_record_sets(
</span></span><span style="display:flex;"><span>        HostedZoneId<span style="color:#04a5e5;font-weight:bold">=</span>hosted_zone_id,
</span></span><span style="display:flex;"><span>        ChangeBatch<span style="color:#04a5e5;font-weight:bold">=</span>change_batch
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#40a02b">&#34;DNS record created or updated successfully.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">def</span> <span style="color:#1e66f5">delete_dns_record</span>(hosted_zone_id, record_name, record_value):
</span></span><span style="display:flex;"><span>    <span style="color:#40a02b">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    Delete a DNS validation record from Route 53.
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Deleting DNS record: </span><span style="color:#40a02b">{</span>record_name<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>    change_batch <span style="color:#04a5e5;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#40a02b">&#39;Changes&#39;</span>: [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#40a02b">&#39;Action&#39;</span>: <span style="color:#40a02b">&#39;DELETE&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#40a02b">&#39;ResourceRecordSet&#39;</span>: {
</span></span><span style="display:flex;"><span>                    <span style="color:#40a02b">&#39;Name&#39;</span>: record_name,
</span></span><span style="display:flex;"><span>                    <span style="color:#40a02b">&#39;Type&#39;</span>: <span style="color:#40a02b">&#39;CNAME&#39;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#40a02b">&#39;TTL&#39;</span>: <span style="color:#fe640b">60</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#40a02b">&#39;ResourceRecords&#39;</span>: [{<span style="color:#40a02b">&#39;Value&#39;</span>: record_value}]
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    route53_client<span style="color:#04a5e5;font-weight:bold">.</span>change_resource_record_sets(
</span></span><span style="display:flex;"><span>        HostedZoneId<span style="color:#04a5e5;font-weight:bold">=</span>hosted_zone_id,
</span></span><span style="display:flex;"><span>        ChangeBatch<span style="color:#04a5e5;font-weight:bold">=</span>change_batch
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#40a02b">&#34;DNS record deleted successfully.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">def</span> <span style="color:#1e66f5">delete_acm_certificate</span>(certificate_arn):
</span></span><span style="display:flex;"><span>    <span style="color:#40a02b">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    Delete the ACM certificate if it exists and is valid.
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Deleting ACM certificate: </span><span style="color:#40a02b">{</span>certificate_arn<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">try</span>:
</span></span><span style="display:flex;"><span>        acm_client<span style="color:#04a5e5;font-weight:bold">.</span>delete_certificate(CertificateArn<span style="color:#04a5e5;font-weight:bold">=</span>certificate_arn)
</span></span><span style="display:flex;"><span>        logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#40a02b">&#34;ACM certificate deleted successfully.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">except</span> <span style="color:#fe640b">Exception</span> <span style="color:#8839ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#04a5e5;font-weight:bold">.</span>error(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Error deleting ACM certificate: </span><span style="color:#40a02b">{</span><span style="color:#04a5e5">str</span>(e)<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>, exc_info<span style="color:#04a5e5;font-weight:bold">=</span><span style="color:#fe640b">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">def</span> <span style="color:#1e66f5">wait_and_fetch_cert_resource_record</span>(acm_client, certificate_arn, timeout<span style="color:#04a5e5;font-weight:bold">=</span><span style="color:#fe640b">300</span>, interval<span style="color:#04a5e5;font-weight:bold">=</span><span style="color:#fe640b">15</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#40a02b">&#34;&#34;&#34;Wait until the ACM certificate includes the ResourceRecord.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    start_time <span style="color:#04a5e5;font-weight:bold">=</span> time<span style="color:#04a5e5;font-weight:bold">.</span>time()
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">while</span> <span style="color:#fe640b">True</span>:
</span></span><span style="display:flex;"><span>        cert_details <span style="color:#04a5e5;font-weight:bold">=</span> acm_client<span style="color:#04a5e5;font-weight:bold">.</span>describe_certificate(CertificateArn<span style="color:#04a5e5;font-weight:bold">=</span>certificate_arn)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;cert_details: </span><span style="color:#40a02b">{</span>cert_details<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        validation_options <span style="color:#04a5e5;font-weight:bold">=</span> cert_details[<span style="color:#40a02b">&#39;Certificate&#39;</span>][<span style="color:#40a02b">&#39;DomainValidationOptions&#39;</span>][<span style="color:#fe640b">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#9ca0b0;font-style:italic"># Check if the ResourceRecord is available</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">if</span> <span style="color:#40a02b">&#39;ResourceRecord&#39;</span> <span style="color:#04a5e5;font-weight:bold">in</span> validation_options:
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">return</span> validation_options[<span style="color:#40a02b">&#39;ResourceRecord&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#9ca0b0;font-style:italic"># Check for timeout</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">if</span> time<span style="color:#04a5e5;font-weight:bold">.</span>time() <span style="color:#04a5e5;font-weight:bold">-</span> start_time <span style="color:#04a5e5;font-weight:bold">&gt;</span> timeout:
</span></span><span style="display:flex;"><span>            logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#40a02b">&#34;Timeout waiting for ACM certificate ResourceRecord. Will try again&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Waiting for ResourceRecord. Current status: </span><span style="color:#40a02b">{</span>validation_options[<span style="color:#40a02b">&#39;ValidationStatus&#39;</span>]<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>        time<span style="color:#04a5e5;font-weight:bold">.</span>sleep(interval)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">def</span> <span style="color:#1e66f5">lambda_handler</span>(event, context):
</span></span><span style="display:flex;"><span>    <span style="color:#40a02b">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    Lambda function to handle ACM certificate DNS validation via Route 53.
</span></span></span><span style="display:flex;"><span><span style="color:#40a02b">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#9ca0b0;font-style:italic"># Log the received event for debugging</span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Received event: </span><span style="color:#40a02b">{</span>json<span style="color:#04a5e5;font-weight:bold">.</span>dumps(event)<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#9ca0b0;font-style:italic"># Extract parameters from the event</span>
</span></span><span style="display:flex;"><span>        props <span style="color:#04a5e5;font-weight:bold">=</span> event<span style="color:#04a5e5;font-weight:bold">.</span>get(<span style="color:#40a02b">&#39;ResourceProperties&#39;</span>, {})
</span></span><span style="display:flex;"><span>        domain_name <span style="color:#04a5e5;font-weight:bold">=</span> props<span style="color:#04a5e5;font-weight:bold">.</span>get(<span style="color:#40a02b">&#39;DomainName&#39;</span>)
</span></span><span style="display:flex;"><span>        hosted_zone_id <span style="color:#04a5e5;font-weight:bold">=</span> props<span style="color:#04a5e5;font-weight:bold">.</span>get(<span style="color:#40a02b">&#39;HostedZoneId&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#9ca0b0;font-style:italic"># Early fail, if missing properties</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">if</span> <span style="color:#04a5e5;font-weight:bold">not</span> <span style="color:#04a5e5">all</span>([domain_name, hosted_zone_id]):
</span></span><span style="display:flex;"><span>            error_message <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#40a02b">&#34;Missing one or more required properties.&#34;</span>
</span></span><span style="display:flex;"><span>            logger<span style="color:#04a5e5;font-weight:bold">.</span>error(error_message)
</span></span><span style="display:flex;"><span>            send_response(
</span></span><span style="display:flex;"><span>                event,
</span></span><span style="display:flex;"><span>                context,
</span></span><span style="display:flex;"><span>                response_status <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#40a02b">&#39;FAILED&#39;</span>,
</span></span><span style="display:flex;"><span>                response_data <span style="color:#04a5e5;font-weight:bold">=</span> {<span style="color:#40a02b">&#39;Message&#39;</span>: error_message}
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">return</span> {<span style="color:#40a02b">&#39;statusCode&#39;</span>: <span style="color:#fe640b">500</span>, <span style="color:#40a02b">&#39;body&#39;</span>: error_message}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#9ca0b0;font-style:italic"># CREATE/UPDATE share same code, and DELETE has its own block</span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Processing </span><span style="color:#40a02b">{</span>event[<span style="color:#40a02b">&#39;RequestType&#39;</span>]<span style="color:#40a02b">}</span><span style="color:#40a02b"> request for domain: </span><span style="color:#40a02b">{</span>domain_name<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">if</span> event[<span style="color:#40a02b">&#39;RequestType&#39;</span>] <span style="color:#04a5e5;font-weight:bold">in</span> [<span style="color:#40a02b">&#39;Create&#39;</span>, <span style="color:#40a02b">&#39;Update&#39;</span>]:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            response <span style="color:#04a5e5;font-weight:bold">=</span> acm_client<span style="color:#04a5e5;font-weight:bold">.</span>request_certificate(
</span></span><span style="display:flex;"><span>                DomainName<span style="color:#04a5e5;font-weight:bold">=</span>domain_name,
</span></span><span style="display:flex;"><span>                ValidationMethod<span style="color:#04a5e5;font-weight:bold">=</span><span style="color:#40a02b">&#39;DNS&#39;</span>,
</span></span><span style="display:flex;"><span>                SubjectAlternativeNames<span style="color:#04a5e5;font-weight:bold">=</span>[domain_name],
</span></span><span style="display:flex;"><span>                Options<span style="color:#04a5e5;font-weight:bold">=</span>{<span style="color:#40a02b">&#39;CertificateTransparencyLoggingPreference&#39;</span>: <span style="color:#40a02b">&#39;ENABLED&#39;</span>}
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            certificate_arn <span style="color:#04a5e5;font-weight:bold">=</span> response[<span style="color:#40a02b">&#39;CertificateArn&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#9ca0b0;font-style:italic"># Check if CertificateArn is available before proceeding with Create or Update actions</span>
</span></span><span style="display:flex;"><span>            <span style="color:#9ca0b0;font-style:italic">## We might want to put some re-try mechanism here</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">if</span> certificate_arn <span style="color:#04a5e5;font-weight:bold">is</span> <span style="color:#fe640b">None</span>:
</span></span><span style="display:flex;"><span>                error_message <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#40a02b">&#34;CertificateArn is missing, cannot proceed with certificate validation.&#34;</span>
</span></span><span style="display:flex;"><span>                logger<span style="color:#04a5e5;font-weight:bold">.</span>error(error_message)
</span></span><span style="display:flex;"><span>                send_response(
</span></span><span style="display:flex;"><span>                    event,
</span></span><span style="display:flex;"><span>                    context,
</span></span><span style="display:flex;"><span>                    response_status <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#40a02b">&#39;FAILED&#39;</span>,
</span></span><span style="display:flex;"><span>                    response_data <span style="color:#04a5e5;font-weight:bold">=</span> {<span style="color:#40a02b">&#39;Message&#39;</span>: error_message}
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">return</span> {<span style="color:#40a02b">&#39;statusCode&#39;</span>: <span style="color:#fe640b">500</span>, <span style="color:#40a02b">&#39;body&#39;</span>: error_message}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Requested certificate: </span><span style="color:#40a02b">{</span>certificate_arn<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#9ca0b0;font-style:italic"># Re-try mechanism here</span>
</span></span><span style="display:flex;"><span>            resource_record <span style="color:#04a5e5;font-weight:bold">=</span> wait_and_fetch_cert_resource_record(acm_client, certificate_arn)
</span></span><span style="display:flex;"><span>            validation_record_name <span style="color:#04a5e5;font-weight:bold">=</span> resource_record[<span style="color:#40a02b">&#39;Name&#39;</span>]
</span></span><span style="display:flex;"><span>            validation_record_value <span style="color:#04a5e5;font-weight:bold">=</span> resource_record[<span style="color:#40a02b">&#39;Value&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#9ca0b0;font-style:italic"># Create or update the DNS record for DNS validation</span>
</span></span><span style="display:flex;"><span>            logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;DNS validation record: </span><span style="color:#40a02b">{</span>validation_record_name<span style="color:#40a02b">}</span><span style="color:#40a02b"> -&gt; </span><span style="color:#40a02b">{</span>validation_record_value<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>            create_dns_record(
</span></span><span style="display:flex;"><span>                hosted_zone_id, validation_record_name, validation_record_value
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#9ca0b0;font-style:italic"># Send response to CloudFormation (Important!!! without it, it&#39;ll endlessly wait for the response that we never sent)</span>
</span></span><span style="display:flex;"><span>            send_response(
</span></span><span style="display:flex;"><span>                event,
</span></span><span style="display:flex;"><span>                context,
</span></span><span style="display:flex;"><span>                response_status <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#40a02b">&#39;SUCCESS&#39;</span>,
</span></span><span style="display:flex;"><span>                response_data <span style="color:#04a5e5;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#40a02b">&#39;Message&#39;</span>: <span style="color:#40a02b">&#39;ACM Certificate created and validated.&#39;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#40a02b">&#39;CertificateArn&#39;</span>: certificate_arn
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>                physical_resource_id<span style="color:#04a5e5;font-weight:bold">=</span>certificate_arn
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">return</span> {<span style="color:#40a02b">&#39;statusCode&#39;</span>: <span style="color:#fe640b">200</span>, <span style="color:#40a02b">&#39;body&#39;</span>: json<span style="color:#04a5e5;font-weight:bold">.</span>dumps(<span style="color:#40a02b">&#39;Validation record processed successfully.&#39;</span>)}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">elif</span> event[<span style="color:#40a02b">&#39;RequestType&#39;</span>] <span style="color:#04a5e5;font-weight:bold">==</span> <span style="color:#40a02b">&#39;Delete&#39;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">if</span> event[<span style="color:#40a02b">&#39;PhysicalResourceId&#39;</span>] <span style="color:#04a5e5;font-weight:bold">is</span> <span style="color:#fe640b">None</span>:
</span></span><span style="display:flex;"><span>                error_message <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#40a02b">&#34;CertificateArn is missing, cannot proceed with certificate validation.&#34;</span>
</span></span><span style="display:flex;"><span>                logger<span style="color:#04a5e5;font-weight:bold">.</span>error(error_message)
</span></span><span style="display:flex;"><span>                send_response(
</span></span><span style="display:flex;"><span>                    event,
</span></span><span style="display:flex;"><span>                    context,
</span></span><span style="display:flex;"><span>                    response_status <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#40a02b">&#39;FAILED&#39;</span>,
</span></span><span style="display:flex;"><span>                    response_data <span style="color:#04a5e5;font-weight:bold">=</span> {<span style="color:#40a02b">&#39;Message&#39;</span>: error_message}
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">return</span> {<span style="color:#40a02b">&#39;statusCode&#39;</span>: <span style="color:#fe640b">500</span>, <span style="color:#40a02b">&#39;body&#39;</span>: error_message}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            certificate_arn <span style="color:#04a5e5;font-weight:bold">=</span> event[<span style="color:#40a02b">&#39;PhysicalResourceId&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            resource_record <span style="color:#04a5e5;font-weight:bold">=</span> wait_and_fetch_cert_resource_record(acm_client, certificate_arn)
</span></span><span style="display:flex;"><span>            validation_record_name <span style="color:#04a5e5;font-weight:bold">=</span> resource_record[<span style="color:#40a02b">&#39;Name&#39;</span>]
</span></span><span style="display:flex;"><span>            validation_record_value <span style="color:#04a5e5;font-weight:bold">=</span> resource_record[<span style="color:#40a02b">&#39;Value&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Deleting DNS record: </span><span style="color:#40a02b">{</span>validation_record_name<span style="color:#40a02b">}</span><span style="color:#40a02b"> -&gt; </span><span style="color:#40a02b">{</span>validation_record_value<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>            delete_dns_record(
</span></span><span style="display:flex;"><span>                hosted_zone_id, validation_record_name, validation_record_value
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            logger<span style="color:#04a5e5;font-weight:bold">.</span>info(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Deleting certificate: </span><span style="color:#40a02b">{</span>certificate_arn<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)
</span></span><span style="display:flex;"><span>            delete_acm_certificate(certificate_arn)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            send_response(
</span></span><span style="display:flex;"><span>                event,
</span></span><span style="display:flex;"><span>                context,
</span></span><span style="display:flex;"><span>                response_status <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#40a02b">&#39;SUCCESS&#39;</span>,
</span></span><span style="display:flex;"><span>                response_data <span style="color:#04a5e5;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#40a02b">&#39;Message&#39;</span>: <span style="color:#40a02b">&#34;Validation record and certificate deleted successfully.&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#40a02b">&#39;CertificateArn&#39;</span>: certificate_arn
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>                physical_resource_id<span style="color:#04a5e5;font-weight:bold">=</span>certificate_arn
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">return</span> {<span style="color:#40a02b">&#39;statusCode&#39;</span>: <span style="color:#fe640b">200</span>, <span style="color:#40a02b">&#39;body&#39;</span>: json<span style="color:#04a5e5;font-weight:bold">.</span>dumps(<span style="color:#40a02b">&#34;Validation record and certificate deleted successfully.&#34;</span>)}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">except</span> <span style="color:#fe640b">Exception</span> <span style="color:#8839ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#04a5e5;font-weight:bold">.</span>error(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Error processing validation: </span><span style="color:#40a02b">{</span><span style="color:#04a5e5">str</span>(e)<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>, exc_info<span style="color:#04a5e5;font-weight:bold">=</span><span style="color:#fe640b">True</span>)
</span></span><span style="display:flex;"><span>        send_response(
</span></span><span style="display:flex;"><span>            event,
</span></span><span style="display:flex;"><span>            context,
</span></span><span style="display:flex;"><span>            response_status <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#40a02b">&#39;FAILED&#39;</span>,
</span></span><span style="display:flex;"><span>            response_data <span style="color:#04a5e5;font-weight:bold">=</span> {<span style="color:#40a02b">&#39;Message&#39;</span>: <span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Error: </span><span style="color:#40a02b">{</span><span style="color:#04a5e5">str</span>(e)<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>}
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">return</span> {<span style="color:#40a02b">&#39;statusCode&#39;</span>: <span style="color:#fe640b">500</span>, <span style="color:#40a02b">&#39;body&#39;</span>: json<span style="color:#04a5e5;font-weight:bold">.</span>dumps(<span style="color:#d20f39">f</span><span style="color:#40a02b">&#34;Error: </span><span style="color:#40a02b">{</span><span style="color:#04a5e5">str</span>(e)<span style="color:#40a02b">}</span><span style="color:#40a02b">&#34;</span>)}
</span></span></code></pre></div><p>After we push this to Github, we should see all the resources created successfully.</p>
<p>The CloudFormation Stack.</p>
<p><img src="screenshots/iac-cloudformation-1.png" alt=""></p>
<p>The Lambda function.</p>
<p><img src="screenshots/iac-lambda-1.png" alt=""></p>
<p>The ACM cert.</p>
<p><img src="screenshots/iac-acm-1.png" alt=""></p>
<p>The Route 53 record.</p>
<p><img src="screenshots/iac-route53-1.png" alt=""></p>
<p>Great! That was a very long section, hopefully it all makes sense. Now that we have an ACM cert set up, we can associate it with a cloudfront distribution.</p>
<h3 id="step-3-cloudfront">Step 3. CloudFront</h3>
<p>Make a <code>cloudfront.yml</code> file under <code>infra</code> folder. We&rsquo;re going to be making the following stack resources.</p>
<ul>
<li>A new S3 bucket (<code>S3ForCloudFrontLogs</code>) to store Cloudfront logs, and a policy for it (<code>CloudFrontLogBucketPolicy</code>).</li>
<li>We&rsquo;ll use OAC to add the static-site.jiwanheo.xyz bucket as the origin (<code>MyCloudFrontOAC</code>), as well as the S3 bucket policy to let cloudfront make GET requests (<code>CloudFrontSiteBucketPolicy</code>).</li>
<li>The CloudFront distribution itself (<code>CloudFrontDistribution</code>)</li>
<li>And a Route 53 A record (<code>Route53DNSRecord</code>)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">Description</span>: Set up CloudFront Distribution and Route53 DNS for the static site
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">Resources</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">S3ForCloudFrontLogs</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::S3::Bucket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">MyCloudFrontOAC</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::CloudFront::OriginAccessControl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">CloudFrontDistribution</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::CloudFront::Distribution
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">CloudFrontLogBucketPolicy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::S3::BucketPolicy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">CloudFrontSiteBucketPolicy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::S3::BucketPolicy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Route53DNSRecord</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::Route53::RecordSet
</span></span></code></pre></div><p>Starting with <code>S3ForCloudFrontLogs</code>, the following YAML is pretty standard. I used the <code>AccessControl</code> and <code>OwnershipControls</code> to enable writing logs. AWS recommend you don&rsquo;t use ACLs, but I couldn&rsquo;t get it to work otherwise.</p>
<p><code>AccessControl: LogDeliveryWrite</code> grants write permissions to AWS services like CloudFront. <code>BucketOwnerPreferred</code> makes sure objects written to this bucket by other accounts will have me (the bucket owner) as the object owner.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">S3ForCloudFrontLogs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Type</span>: AWS::S3::Bucket
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">BucketName</span>: cloudfront-logs.jiwanheo.xyz
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">VersioningConfiguration</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Status</span>: Enabled <span style="color:#9ca0b0;font-style:italic"># Enable versioning if needed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">AccessControl</span>: LogDeliveryWrite
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">OwnershipControls</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Rules</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#8839ef">ObjectOwnership</span>: BucketOwnerPreferred
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">PublicAccessBlockConfiguration</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">BlockPublicAcls</span>: <span style="color:#fe640b">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">BlockPublicPolicy</span>: <span style="color:#fe640b">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">IgnorePublicAcls</span>: <span style="color:#fe640b">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">RestrictPublicBuckets</span>: <span style="color:#fe640b">true</span>
</span></span></code></pre></div><p>The bucket policy is also straightforward. We&rsquo;re allowing CloudFront to make a PUT request.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">CloudFrontLogBucketPolicy</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Type</span>: AWS::S3::BucketPolicy
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Bucket</span>: !Ref S3ForCloudFrontLogs
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">PolicyDocument</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#8839ef">Sid</span>: <span style="color:#40a02b">&#34;AllowCloudFrontLogs&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Effect</span>: <span style="color:#40a02b">&#34;Allow&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Principal</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Service</span>: <span style="color:#40a02b">&#34;cloudfront.amazonaws.com&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Action</span>: <span style="color:#40a02b">&#34;s3:PutObject&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Resource</span>: !Sub &#34;arn:aws:s3:::${S3ForCloudFrontLogs}/*&#34;
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Condition</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">StringEquals</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#8839ef">&#34;AWS:SourceArn&#34;: </span>!Sub &#34;arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}&#34;
</span></span></code></pre></div><p>The Origin Access Control configuration that we&rsquo;ll use to link the S3 bucket to the cloudfront distribution.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">MyCloudFrontOAC</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Type</span>: AWS::CloudFront::OriginAccessControl
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">OriginAccessControlConfig</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Name</span>: <span style="color:#40a02b">&#34;CloudFrontOAC&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Description</span>: <span style="color:#40a02b">&#34;OAC for S3 bucket access&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">OriginAccessControlOriginType</span>: <span style="color:#40a02b">&#34;s3&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">SigningBehavior</span>: <span style="color:#40a02b">&#34;always&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">SigningProtocol</span>: <span style="color:#40a02b">&#34;sigv4&#34;</span> <span style="color:#9ca0b0;font-style:italic"># Use AWS Signature Version 4 (sigv4)</span>
</span></span></code></pre></div><p>And the bucket policy for the S3 bucket that holds the website. It allows CloudFront to make a GET request.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">CloudFrontSiteBucketPolicy</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Type</span>: AWS::S3::BucketPolicy
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Bucket</span>: !ImportValue StaticSiteS3BucketName
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">PolicyDocument</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#8839ef">Sid</span>: <span style="color:#40a02b">&#34;AllowCloudFrontGets&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Effect</span>: <span style="color:#40a02b">&#34;Allow&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Principal</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Service</span>: <span style="color:#40a02b">&#34;cloudfront.amazonaws.com&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Action</span>: <span style="color:#40a02b">&#34;s3:GetObject&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Resource</span>: !Sub
</span></span><span style="display:flex;"><span>            - <span style="color:#40a02b">&#34;arn:aws:s3:::${BucketName}/*&#34;</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#8839ef">BucketName</span>: !ImportValue StaticSiteS3BucketName
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Condition</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">StringEquals</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#8839ef">&#34;AWS:SourceArn&#34;: </span>!Sub &#34;arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}&#34;
</span></span></code></pre></div><p>The Route53 record. The HostedZoneId under AliasTarget is global for all cloudfront distributions, no need to change it.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">Route53DNSRecord</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Type</span>: AWS::Route53::RecordSet
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">HostedZoneId</span>: Z066358329E65RHIEOJXQ <span style="color:#9ca0b0;font-style:italic"># Replace with your actual hosted zone ID</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Name</span>: static-site.jiwanheo.xyz
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: A
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">AliasTarget</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">DNSName</span>: !GetAtt CloudFrontDistribution.DomainName <span style="color:#9ca0b0;font-style:italic"># CloudFront distribution domain name</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">HostedZoneId</span>: Z2FDTNDATAQYW2
</span></span></code></pre></div><p>Ok! Now the actual cloudfront distribution. Under DistributionConfig/Origins, we list the S3 bucket that holds the site, as our origin, using the OAC we created earlier. Under DefaultCacheBehavior, we&rsquo;ll set ViewerProtocolPolicy to redirect-to-https, because we have an SSL cert, which we set at ViewerCertificate. And finally, we enable logging by setting Logging.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">CloudFrontDistribution</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Type</span>: AWS::CloudFront::Distribution
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">DistributionConfig</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Aliases</span>:
</span></span><span style="display:flex;"><span>        - static-site.jiwanheo.xyz
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Origins</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#8839ef">Id</span>: S3Origin
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">DomainName</span>: !ImportValue S3BucketDomainName
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">S3OriginConfig</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#9ca0b0;font-style:italic"># AWS docs instruct to leave this field empty if using OAC instead of OAI</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">OriginAccessIdentity</span>: <span style="color:#40a02b">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">OriginAccessControlId</span>: !Ref MyCloudFrontOAC <span style="color:#9ca0b0;font-style:italic"># Use OAC here</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Enabled</span>: <span style="color:#fe640b">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">DefaultCacheBehavior</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">TargetOriginId</span>: S3Origin
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">ViewerProtocolPolicy</span>: redirect-to-https <span style="color:#9ca0b0;font-style:italic"># Ensure HTTPS is enforced</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">AllowedMethods</span>:
</span></span><span style="display:flex;"><span>          - GET
</span></span><span style="display:flex;"><span>          - HEAD
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">CachedMethods</span>:
</span></span><span style="display:flex;"><span>          - GET
</span></span><span style="display:flex;"><span>          - HEAD
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">ForwardedValues</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">QueryString</span>: <span style="color:#fe640b">false</span> <span style="color:#9ca0b0;font-style:italic"># Do not forward query strings to S3</span>
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Cookies</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Forward</span>: none <span style="color:#9ca0b0;font-style:italic"># Do not forward cookies</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">ViewerCertificate</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">AcmCertificateArn</span>: !ImportValue MySSLCertificateStack-CertificateArn
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">SslSupportMethod</span>: sni-only
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">MinimumProtocolVersion</span>: TLSv1.2_2021
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">DefaultRootObject</span>: index.html
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">HttpVersion</span>: http2
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">PriceClass</span>: PriceClass_100 <span style="color:#9ca0b0;font-style:italic"># Use the cheapest price class (optional)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Logging</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Bucket</span>: !Sub &#34;${S3ForCloudFrontLogs}.s3.amazonaws.com&#34;
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">IncludeCookies</span>: <span style="color:#fe640b">false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Prefix</span>: <span style="color:#40a02b">&#34;cloudfront-logs/&#34;</span>
</span></span></code></pre></div><p>Putting that all together, we have</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">Description</span>: Set up CloudFront Distribution and Route53 DNS for the static site
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">Resources</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">S3ForCloudFrontLogs</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::S3::Bucket
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">BucketName</span>: cloudfront-logs.jiwanheo.xyz
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">VersioningConfiguration</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Status</span>: Enabled <span style="color:#9ca0b0;font-style:italic"># Enable versioning if needed</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">AccessControl</span>: LogDeliveryWrite
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">OwnershipControls</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Rules</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#8839ef">ObjectOwnership</span>: BucketOwnerPreferred
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">PublicAccessBlockConfiguration</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">BlockPublicAcls</span>: <span style="color:#fe640b">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">BlockPublicPolicy</span>: <span style="color:#fe640b">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">IgnorePublicAcls</span>: <span style="color:#fe640b">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">RestrictPublicBuckets</span>: <span style="color:#fe640b">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">MyCloudFrontOAC</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::CloudFront::OriginAccessControl
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">OriginAccessControlConfig</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Name</span>: <span style="color:#40a02b">&#34;CloudFrontOAC&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Description</span>: <span style="color:#40a02b">&#34;OAC for S3 bucket access&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">OriginAccessControlOriginType</span>: <span style="color:#40a02b">&#34;s3&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">SigningBehavior</span>: <span style="color:#40a02b">&#34;always&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">SigningProtocol</span>: <span style="color:#40a02b">&#34;sigv4&#34;</span> <span style="color:#9ca0b0;font-style:italic"># Use AWS Signature Version 4 (sigv4)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">CloudFrontDistribution</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::CloudFront::Distribution
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">DistributionConfig</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Aliases</span>:
</span></span><span style="display:flex;"><span>          - static-site.jiwanheo.xyz
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Origins</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#8839ef">Id</span>: S3Origin
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">DomainName</span>: !ImportValue S3BucketDomainName
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">S3OriginConfig</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#9ca0b0;font-style:italic"># AWS docs instruct to leave this field empty if using OAC instead of OAI</span>
</span></span><span style="display:flex;"><span>              <span style="color:#8839ef">OriginAccessIdentity</span>: <span style="color:#40a02b">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">OriginAccessControlId</span>: !Ref MyCloudFrontOAC <span style="color:#9ca0b0;font-style:italic"># Use OAC here</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Enabled</span>: <span style="color:#fe640b">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">DefaultCacheBehavior</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">TargetOriginId</span>: S3Origin
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">ViewerProtocolPolicy</span>: redirect-to-https <span style="color:#9ca0b0;font-style:italic"># Ensure HTTPS is enforced</span>
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">AllowedMethods</span>:
</span></span><span style="display:flex;"><span>            - GET
</span></span><span style="display:flex;"><span>            - HEAD
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">CachedMethods</span>:
</span></span><span style="display:flex;"><span>            - GET
</span></span><span style="display:flex;"><span>            - HEAD
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">ForwardedValues</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">QueryString</span>: <span style="color:#fe640b">false</span> <span style="color:#9ca0b0;font-style:italic"># Do not forward query strings to S3</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Cookies</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#8839ef">Forward</span>: none <span style="color:#9ca0b0;font-style:italic"># Do not forward cookies</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">ViewerCertificate</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">AcmCertificateArn</span>: !ImportValue MySSLCertificateStack-CertificateArn
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">SslSupportMethod</span>: sni-only
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">MinimumProtocolVersion</span>: TLSv1.2_2021
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">DefaultRootObject</span>: index.html
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">HttpVersion</span>: http2
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">PriceClass</span>: PriceClass_100 <span style="color:#9ca0b0;font-style:italic"># Use the cheapest price class (optional)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Logging</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Bucket</span>: !Sub &#34;${S3ForCloudFrontLogs}.s3.amazonaws.com&#34;
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">IncludeCookies</span>: <span style="color:#fe640b">false</span>
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Prefix</span>: <span style="color:#40a02b">&#34;cloudfront-logs/&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">CloudFrontLogBucketPolicy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::S3::BucketPolicy
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Bucket</span>: !Ref S3ForCloudFrontLogs
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">PolicyDocument</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#8839ef">Sid</span>: <span style="color:#40a02b">&#34;AllowCloudFrontLogs&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Effect</span>: <span style="color:#40a02b">&#34;Allow&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Principal</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#8839ef">Service</span>: <span style="color:#40a02b">&#34;cloudfront.amazonaws.com&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Action</span>: <span style="color:#40a02b">&#34;s3:PutObject&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Resource</span>: !Sub &#34;arn:aws:s3:::${S3ForCloudFrontLogs}/*&#34;
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Condition</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#8839ef">StringEquals</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">&#34;AWS:SourceArn&#34;: </span>!Sub &#34;arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">CloudFrontSiteBucketPolicy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::S3::BucketPolicy
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Bucket</span>: !ImportValue StaticSiteS3BucketName
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">PolicyDocument</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#8839ef">Sid</span>: <span style="color:#40a02b">&#34;AllowCloudFrontGets&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Effect</span>: <span style="color:#40a02b">&#34;Allow&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Principal</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#8839ef">Service</span>: <span style="color:#40a02b">&#34;cloudfront.amazonaws.com&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Action</span>: <span style="color:#40a02b">&#34;s3:GetObject&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Resource</span>: !Sub
</span></span><span style="display:flex;"><span>              - <span style="color:#40a02b">&#34;arn:aws:s3:::${BucketName}/*&#34;</span>
</span></span><span style="display:flex;"><span>              - <span style="color:#8839ef">BucketName</span>: !ImportValue StaticSiteS3BucketName
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Condition</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#8839ef">StringEquals</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">&#34;AWS:SourceArn&#34;: </span>!Sub &#34;arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Route53DNSRecord</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::Route53::RecordSet
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">HostedZoneId</span>: Z066358329E65RHIEOJXQ <span style="color:#9ca0b0;font-style:italic"># Replace with your actual hosted zone ID</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Name</span>: static-site.jiwanheo.xyz
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Type</span>: A
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">AliasTarget</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">DNSName</span>: !GetAtt CloudFrontDistribution.DomainName <span style="color:#9ca0b0;font-style:italic"># CloudFront distribution domain name</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">HostedZoneId</span>: Z2FDTNDATAQYW2
</span></span><span style="display:flex;"><span><span style="color:#8839ef">Outputs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">CloudFrontDomainName</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Description</span>: CloudFront Distribution Domain Name
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Value</span>: !GetAtt CloudFrontDistribution.DomainName
</span></span></code></pre></div><p>With this code, you should be able to go to <code>static-site.jiwanheo.xyz</code> to see your website!</p>
<h3 id="4-monitor-usage">4. Monitor usage</h3>
<p>Create a file called &ldquo;usage.yml&rdquo; under <code>infra</code>. We&rsquo;ll be monitoring the number of requests to our CloudFront distribution, and disable/enable it automatically. Here&rsquo;s what we need to do.</p>
<ul>
<li>Create an SNS topic</li>
<li>Subscribe my email to it</li>
<li>Create a Lambda function</li>
<li>IAM role for Lambda to talk to CloudFront &amp; CloudWatch Logs</li>
<li>Resource-based policy in Lambda to allow SNS to invoke it</li>
<li>Subscribe the Lambda function to SNS</li>
<li>Create CloudWatch alarm on number of requests</li>
</ul>
<p>Here&rsquo;s the outline of our YAML file</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">Description</span>: Set up usage notification and action
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">Resources</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">MySnsTopic</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::SNS::Topic
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">MySnsTopicEmailSubscription</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::SNS::Subscription
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">CustomUsageLambdaExecutionRole</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::IAM::Role
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">CustomUsageLambdaFunction</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::Lambda::Function
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">SNSInvokePermission</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::Lambda::Permission
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">SnsSubscriptionToLambda</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::SNS::Subscription
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">CloudFrontRequestAlarm</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::CloudWatch::Alarm
</span></span></code></pre></div><p>And we&rsquo;ll add step 7 &amp; 8 to our deploy-cloudformation.yml, similar to what we did at sslcert.yml.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"># Step 7: Deploy Usage Lambda function</span>
</span></span><span style="display:flex;"><span>- <span style="color:#8839ef">name</span>: Package and Upload Usage Lambda Code
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">run</span>: |<span style="color:#9ca0b0">
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">    cd infra/lambda
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">    zip -r usage_lambda_function.zip usage_lambda_function.py
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">    aws s3 cp usage_lambda_function.zip s3://usage-lambda-for-static-site.jiwanheo.xyz/usage_lambda_function.zip</span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"># Step 8: Deploy Usage Stack</span>
</span></span><span style="display:flex;"><span>- <span style="color:#8839ef">name</span>: Deploy Usage Stack
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">run</span>: |<span style="color:#9ca0b0">
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">    aws cloudformation deploy \
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">      --template-file infra/usage.yml \
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">      --stack-name UsageStack \
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0">      --capabilities CAPABILITY_NAMED_IAM</span>    
</span></span></code></pre></div><p>Ok, going back to the usage.yml, most of these are very similar to sslcert.yml</p>
<p><strong>MySnsTopic</strong> and <strong>MySnsTopicEmailSubscription</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">MySnsTopic</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Type</span>: AWS::SNS::Topic
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">TopicName</span>: static-site-high-requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">MySnsTopicEmailSubscription</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Type</span>: AWS::SNS::Subscription
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Protocol</span>: email
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Endpoint</span>: jiwanheo123@gmail.com
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">TopicArn</span>: !Ref MySnsTopic
</span></span></code></pre></div><p><strong>CustomUsageLambdaExecutionRole</strong></p>
<p>We will let the lambda function use cloudfront:GetDistributionConfig, cloudfront:UpdateDistribution on our distribution, as well as logs:CreateLogGroup, logs:CreateLogStream, logs:PutLogEvents to the lambda function log group.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">CustomUsageLambdaExecutionRole</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Type</span>: AWS::IAM::Role
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">AssumeRolePolicyDocument</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#8839ef">Effect</span>: Allow
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Principal</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Service</span>: lambda.amazonaws.com
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Action</span>: sts:AssumeRole
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Policies</span>: <span style="color:#9ca0b0;font-style:italic"># This is a list of policy documents</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#8839ef">PolicyName</span>: LambdaCloudFrontPolicy
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">PolicyDocument</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#8839ef">Effect</span>: Allow
</span></span><span style="display:flex;"><span>              <span style="color:#8839ef">Action</span>:
</span></span><span style="display:flex;"><span>                - cloudfront:GetDistributionConfig
</span></span><span style="display:flex;"><span>                - cloudfront:UpdateDistribution
</span></span><span style="display:flex;"><span>              <span style="color:#8839ef">Resource</span>: !Sub
</span></span><span style="display:flex;"><span>                - <span style="color:#40a02b">&#34;arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistributionId}&#34;</span>
</span></span><span style="display:flex;"><span>                - <span style="color:#8839ef">CloudFrontDistributionId</span>: !ImportValue CloudFrontDistributionId
</span></span><span style="display:flex;"><span>      - <span style="color:#8839ef">PolicyName</span>: LambdaCloudWatchPolicy
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">PolicyDocument</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#8839ef">Effect</span>: Allow
</span></span><span style="display:flex;"><span>              <span style="color:#8839ef">Action</span>:
</span></span><span style="display:flex;"><span>                - logs:CreateLogGroup
</span></span><span style="display:flex;"><span>                - logs:CreateLogStream
</span></span><span style="display:flex;"><span>                - logs:PutLogEvents
</span></span><span style="display:flex;"><span>              <span style="color:#8839ef">Resource</span>:
</span></span><span style="display:flex;"><span>                - !Sub &#34;arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/LambdaFunctionEnableAndDisableCloudFront&#34;
</span></span><span style="display:flex;"><span>                - !Sub &#34;arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/LambdaFunctionEnableAndDisableCloudFront:*&#34;
</span></span></code></pre></div><p><strong>CustomUsageLambdaFunction</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">CustomUsageLambdaFunction</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Type</span>: AWS::Lambda::Function
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">FunctionName</span>: LambdaFunctionEnableAndDisableCloudFront
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Handler</span>: usage_lambda_function.lambda_handler
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Runtime</span>: python3.13
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Code</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">S3Bucket</span>: usage-lambda-for-static-site.jiwanheo.xyz
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">S3Key</span>: usage_lambda_function.zip
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Timeout</span>: <span style="color:#fe640b">300</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Role</span>: !GetAtt CustomUsageLambdaExecutionRole.Arn
</span></span></code></pre></div><p><strong>SNSInvokePermission</strong> and <strong>SnsSubscriptionToLambda</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">SNSInvokePermission</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Type</span>: AWS::Lambda::Permission
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">FunctionName</span>: !GetAtt CustomUsageLambdaFunction.Arn
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Action</span>: lambda:InvokeFunction
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Principal</span>: sns.amazonaws.com
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">SourceArn</span>: !Ref MySnsTopic
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">SnsSubscriptionToLambda</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Type</span>: AWS::SNS::Subscription
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Endpoint</span>: !GetAtt CustomUsageLambdaFunction.Arn <span style="color:#9ca0b0;font-style:italic"># Lambda function ARN as the endpoint</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Protocol</span>: lambda
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">TopicArn</span>: !Ref MySnsTopic
</span></span></code></pre></div><p>And finally the <strong>CloudFrontRequestAlarm</strong></p>
<p>For some reason, I had to put Region: Global under Dimensions, even though the docs say it&rsquo;s Global by default.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">CloudFrontRequestAlarm</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Type</span>: AWS::CloudWatch::Alarm
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">AlarmName</span>: CloudFrontHighRequestCount
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">MetricName</span>: Requests
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Namespace</span>: AWS/CloudFront
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Statistic</span>: Sum
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Period</span>: <span style="color:#fe640b">300</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">EvaluationPeriods</span>: <span style="color:#fe640b">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Threshold</span>: <span style="color:#fe640b">10</span> <span style="color:#9ca0b0;font-style:italic"># Change this threshold based on your needs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">ComparisonOperator</span>: GreaterThanThreshold
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Dimensions</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#8839ef">Name</span>: DistributionId
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Value</span>: !ImportValue CloudFrontDistributionId
</span></span><span style="display:flex;"><span>      - <span style="color:#8839ef">Name</span>: Region
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Value</span>: Global
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">AlarmActions</span>:
</span></span><span style="display:flex;"><span>      - !Ref MySnsTopic <span style="color:#9ca0b0;font-style:italic"># Alarm state - Send notification to SNS</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">OKActions</span>:
</span></span><span style="display:flex;"><span>      - !Ref MySnsTopic <span style="color:#9ca0b0;font-style:italic"># OK state - Send notification to SNS</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">TreatMissingData</span>: notBreaching
</span></span></code></pre></div><p>Putting that all together, we have usage.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#8839ef">Description</span>: Set up usage notification and action
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">Resources</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">MySnsTopic</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::SNS::Topic
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">TopicName</span>: static-site-high-requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">MySnsTopicEmailSubscription</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::SNS::Subscription
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Protocol</span>: email
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Endpoint</span>: jiwanheo123@gmail.com
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">TopicArn</span>: !Ref MySnsTopic
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">CustomUsageLambdaExecutionRole</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::IAM::Role
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">AssumeRolePolicyDocument</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#8839ef">Effect</span>: Allow
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Principal</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#8839ef">Service</span>: lambda.amazonaws.com
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Action</span>: sts:AssumeRole
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Policies</span>: <span style="color:#9ca0b0;font-style:italic"># This is a list of policy documents</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#8839ef">PolicyName</span>: LambdaCloudFrontPolicy
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">PolicyDocument</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#8839ef">Effect</span>: Allow
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">Action</span>:
</span></span><span style="display:flex;"><span>                  - cloudfront:GetDistributionConfig
</span></span><span style="display:flex;"><span>                  - cloudfront:UpdateDistribution
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">Resource</span>: !Sub
</span></span><span style="display:flex;"><span>                  - <span style="color:#40a02b">&#34;arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistributionId}&#34;</span>
</span></span><span style="display:flex;"><span>                  - <span style="color:#8839ef">CloudFrontDistributionId</span>: !ImportValue CloudFrontDistributionId
</span></span><span style="display:flex;"><span>        - <span style="color:#8839ef">PolicyName</span>: LambdaCloudWatchPolicy
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">PolicyDocument</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Version</span>: <span style="color:#40a02b">&#34;2012-10-17&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">Statement</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#8839ef">Effect</span>: Allow
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">Action</span>:
</span></span><span style="display:flex;"><span>                  - logs:CreateLogGroup
</span></span><span style="display:flex;"><span>                  - logs:CreateLogStream
</span></span><span style="display:flex;"><span>                  - logs:PutLogEvents
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">Resource</span>:
</span></span><span style="display:flex;"><span>                  - !Sub &#34;arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/LambdaFunctionEnableAndDisableCloudFront&#34;
</span></span><span style="display:flex;"><span>                  - !Sub &#34;arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/LambdaFunctionEnableAndDisableCloudFront:*&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic"># Lambda Function to Handle ACM Validation</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">CustomUsageLambdaFunction</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::Lambda::Function
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">FunctionName</span>: LambdaFunctionEnableAndDisableCloudFront
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Handler</span>: usage_lambda_function.lambda_handler
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Runtime</span>: python3.13
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Code</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">S3Bucket</span>: usage-lambda-for-static-site.jiwanheo.xyz
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">S3Key</span>: usage_lambda_function.zip
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Timeout</span>: <span style="color:#fe640b">300</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Role</span>: !GetAtt CustomUsageLambdaExecutionRole.Arn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">SNSInvokePermission</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::Lambda::Permission
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">FunctionName</span>: !GetAtt CustomUsageLambdaFunction.Arn
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Action</span>: lambda:InvokeFunction
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Principal</span>: sns.amazonaws.com
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">SourceArn</span>: !Ref MySnsTopic
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">SnsSubscriptionToLambda</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::SNS::Subscription
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Endpoint</span>: !GetAtt CustomUsageLambdaFunction.Arn <span style="color:#9ca0b0;font-style:italic"># Lambda function ARN as the endpoint</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Protocol</span>: lambda
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">TopicArn</span>: !Ref MySnsTopic
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">CloudFrontRequestAlarm</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Type</span>: AWS::CloudWatch::Alarm
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">Properties</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">AlarmName</span>: CloudFrontHighRequestCount
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">MetricName</span>: Requests
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Namespace</span>: AWS/CloudFront
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Statistic</span>: Sum
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Period</span>: <span style="color:#fe640b">300</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">EvaluationPeriods</span>: <span style="color:#fe640b">1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Threshold</span>: <span style="color:#fe640b">10</span> <span style="color:#9ca0b0;font-style:italic"># Change this threshold based on your needs</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">ComparisonOperator</span>: GreaterThanThreshold
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">Dimensions</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#8839ef">Name</span>: DistributionId
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Value</span>: !ImportValue CloudFrontDistributionId
</span></span><span style="display:flex;"><span>        - <span style="color:#8839ef">Name</span>: Region
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">Value</span>: Global
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">AlarmActions</span>:
</span></span><span style="display:flex;"><span>        - !Ref MySnsTopic <span style="color:#9ca0b0;font-style:italic"># Alarm state - Send notification to SNS</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">OKActions</span>:
</span></span><span style="display:flex;"><span>        - !Ref MySnsTopic <span style="color:#9ca0b0;font-style:italic"># OK state - Send notification to SNS</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">TreatMissingData</span>: notBreaching
</span></span></code></pre></div><h3 id="section-wrap-up-3">Section wrap-up</h3>
<p>Hopefully after doing this, you&rsquo;re able to re-produce the disable/enable functionality that we did in the console. While it&rsquo;s tedious to make CloudFormation work, in comparison to doing it on the console manually, it&rsquo;s well worth the effort to document-ize your workflow, so that it&rsquo;s reproduceable every single time. Making small tweaks should be very easy now, and the changes should be predictable.</p>
<h2 id="closing-out">Closing out</h2>
<p>This project demonstrates how to host a static website on AWS while applying best practices like CI/CD and IaC. By leveraging AWS services like S3, Route 53, and CloudFront, you can build scalable and secure solutions for static content delivery. Documenting infrastructure as code not only ensures reproducibility but also makes future updates and enhancements seamless.</p>
<p>Thanks for reading! I hope this guide helps you get started with hosting static websites on AWS.</p>
</div>
          </div>
        </div>
      </div>
    </section>

    <footer class="footer">
  <div class="container">
    <div class="footer__left">
      <div class="footer__copy">
        Theme by <a href='https://github.com/zetxek/adritian-free-hugo-theme' target='_blank' rel='noopener noreferrer'>Adritian</a>, powered by <a href='https://gohugo.io/' target='_blank' rel='noopener noreferrer'>Hugo</a>
      </div>
    </div>
    
  </div>
</footer>
 <script>
  window.addEventListener("load", function() {
    try{
      var observer = window.lozad(".lozad", {
        rootMargin: window.innerHeight / 2 + "px 0px",
        threshold: 0.01
      }); 
      observer.observe();
    } catch(e) {
      console.error(e);
    }
  });
</script>
<script defer src='http://localhost:1313/js/rad-animations.js'></script>
<script defer src='http://localhost:1313/js/library/smooth-scroll.polyfills.min.js'></script>
<script defer src='http://localhost:1313/js/sticky-header.js'></script>
<script defer src='http://localhost:1313/js/smooth-scroll-init.js'></script>
<script defer src='http://localhost:1313/js/library/bootstrap.min.js'></script>





<script>
  window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
</script>



  </body>
</html>

